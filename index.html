<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html { width:100%; height:100%; }
body {
  width:100%; height:100%;
  background:#fff;
  font-family: Arial, Helvetica, sans-serif;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  /* –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —á—ë—Ç–∫–æ—Å—Ç–∏ —à—Ä–∏—Ñ—Ç–∞ –≤ iframe */
  text-rendering: geometricPrecision;
  -webkit-font-smoothing: subpixel-antialiased;
}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.hdr {
  background: linear-gradient(135deg, #013d7e 0%, #1a5fa8 55%, #2272c3 100%);
  padding: 13px 20px 11px;
  flex-shrink: 0;
  position: relative; overflow: hidden;
}
.hdr::before {
  content:''; position:absolute; top:-50px; right:-30px;
  width:150px; height:150px;
  background:rgba(255,255,255,0.06); border-radius:50%;
  pointer-events:none;
}
.emp-name {
  font-size: clamp(15px, 2.3vw, 22px);
  font-weight: 900; color: #fff;
  letter-spacing: -0.01em; line-height: 1.15;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  position: relative; z-index: 1;
}
.emp-sub {
  font-size: clamp(8px, 1vw, 10px);
  color: rgba(255,255,255,0.55);
  letter-spacing: 0.18em; text-transform: uppercase;
  margin-top: 3px; font-weight: 700;
  position: relative; z-index: 1;
}

/* ‚ïê‚ïê‚ïê BODY ‚ïê‚ïê‚ïê */
.body {
  flex:1; min-height:0;
  display: grid;
  grid-template-columns: 1fr 250px;
}

/* ‚ïê‚ïê‚ïê LEFT ‚ïê‚ïê‚ïê */
.left {
  padding: 12px 14px 10px 16px;
  display: flex; flex-direction: column; gap: 9px;
  border-right: 1px solid #edf2f9;
  min-width: 0;
}

.pills { display:flex; gap:8px; flex-shrink:0; }
.pill {
  flex:1; background:#f5f8fd;
  border-radius:10px; padding:9px 12px;
  text-align:center;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  transition: background 0.15s, box-shadow 0.15s;
}
.pill:hover { background:#fff; box-shadow:0 4px 14px rgba(1,61,126,0.10); }
.pill.z1 { border-bottom-color: #c0392b; }
.pill.z2 { border-bottom-color: #9a6e00; }
.pill.z3 { border-bottom-color: #1a6b3a; }

.pill-lbl {
  font-size: clamp(8px, 1vw, 10px); font-weight: 800;
  text-transform: uppercase; letter-spacing: .12em;
  color: #8a9ab5; margin-bottom: 4px;
}
.pill-val {
  font-size: clamp(20px, 3.2vw, 32px);
  font-weight: 900; line-height: 1;
}
.pill-val.z1 { color:#c0392b; }
.pill-val.z2 { color:#9a6e00; }
.pill-val.z3 { color:#1a6b3a; }

.chart-box {
  flex:1; min-height:0;
  position:relative;
}
.chart-box canvas {
  position:absolute; inset:0;
  width:100% !important; height:100% !important;
}

/* ‚ïê‚ïê‚ïê RIGHT ‚ïê‚ïê‚ïê */
.right {
  padding: 12px 14px 12px 12px;
  display: flex; flex-direction: column; gap: 7px;
  background: #fafbfd;
  overflow: hidden;
  min-width: 0;
}

.cmnt {
  background: linear-gradient(135deg, #013d7e, #1a5fa8);
  border-radius: 10px; padding: 9px 12px;
  display: none; gap: 7px; align-items: flex-start;
  cursor: pointer;
  flex-shrink: 0;
  position: relative; overflow: hidden;
}
.cmnt.on { display: flex; }
.cmnt::before {
  content:''; position:absolute; top:-20px; right:-20px;
  width:80px; height:80px;
  background:rgba(255,255,255,0.07); border-radius:50%;
  pointer-events:none;
}
.cmnt-ico { font-size:15px; flex-shrink:0; position:relative; z-index:1; margin-top:1px; }
.cmnt-body { flex:1; position:relative; z-index:1; }
.cmnt-lbl { font-size:9px; font-weight:800; text-transform:uppercase; letter-spacing:.14em; color:rgba(255,255,255,0.5); margin-bottom:3px; }
.cmnt-txt { font-size:clamp(10px,1.3vw,12px); color:#fff; line-height:1.45; }

.metrics { display:flex; flex-direction:column; gap:6px; flex:1; }
.mrow { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.mrow.s1 { grid-template-columns:1fr; }

.m {
  background:#fff; border-radius:9px;
  padding:8px 11px;
  border:1.5px solid #edf2f9;
  cursor:pointer;
  transition:border-color 0.15s, box-shadow 0.15s;
  position:relative; overflow:hidden;
}
.m:hover { border-color:#b8d0f0; box-shadow:0 3px 12px rgba(1,61,126,0.09); }

/* shimmer */
.m::after {
  content:''; position:absolute;
  top:0; left:-80%; width:50%; height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.85),transparent);
  transition:left 0.4s ease;
  pointer-events:none;
}
.m:hover::after { left:130%; }

.ml { font-size:clamp(7px,.9vw,9px); font-weight:800; text-transform:uppercase; letter-spacing:.11em; color:#8a9ab5; margin-bottom:3px; }
.mv { font-size:clamp(12px,1.7vw,17px); font-weight:900; color:#0d1b2e; line-height:1.1; }
.mv.sh { color:#c0392b; }
.mv.so { color:#1a6b3a; }

.badge {
  display:inline-flex; align-items:center;
  padding:2px 9px; border-radius:20px;
  font-size:clamp(11px,1.5vw,14px); font-weight:900;
}
.badge.y { background:#fde8e6; color:#c0392b; }
.badge.n { background:#f0f2f5; color:#8a9ab5; }

/* ripple */
.rpl {
  position:absolute; border-radius:50%;
  background:rgba(1,61,126,0.08);
  transform:scale(0);
  animation:rplA .45s linear;
  pointer-events:none;
}
@keyframes rplA { to { transform:scale(5); opacity:0; } }

/* fade-in stagger ‚Äî NO transform to avoid blur */
.fade { opacity:0; animation:fi .3s ease forwards; }
@keyframes fi { to { opacity:1; } }

.empty { color:#8a9ab5; font-size:14px; text-align:center; padding:40px; }
</style>
</head>
<body>
<div id="R"></div>
<script>
(function(){
  var q=new URLSearchParams(location.search);
  var name=q.get('name'), data=q.get('data');
  var comment=q.get('comment')||'';
  var sal=q.get('sal')||'', avgsal=q.get('avgsal')||'';
  var salHigh=q.get('salhigh')==='1';
  var start=q.get('start')||'\u2014', stop=q.get('stop')||'\u2014';
  var review=q.get('review')||'\u2014';
  var bench=q.get('bench')||'No', iron=q.get('iron')||'No';
  var R=document.getElementById('R');

  if(!name||!data){ document.body.innerHTML="<p class='empty'>\u2190 \u0412\u044b\u0431\u0435\u0440\u0438 \u0441\u0442\u0440\u043e\u043a\u0443</p>"; return; }

  var RAW=data.split('|').map(function(s){
    var lc=s.lastIndexOf(':'),sc=s.lastIndexOf(':',lc-1);
    return{p:s.substring(0,sc),r:parseFloat(s.substring(sc+1,lc))||0,z:parseInt(s.substring(lc+1))||1};
  }).filter(function(d){return d.p;});
  if(!RAW.length){document.body.innerHTML="<p class='empty'>\u041d\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0445</p>";return;}

  var vals=RAW.map(function(d){return d.r;});
  var labs=RAW.map(function(d){return d.p;});
  var zones=RAW.map(function(d){return d.z;});
  var n=vals.length;

  function fp(v){ var p=v*100; return(p<0?'-':'')+Math.abs(p).toFixed(1).replace('.',',')+'\u0025'; }
  function fm(v){ if(!v||v==='0')return'\u2014'; return '$\u00a0'+parseInt(v).toLocaleString('ru-RU'); }
  function iy(v){ return v&&(v.toLowerCase()==='yes'||v==='1'||v.toLowerCase()==='\u0434\u0430'); }

  var BC={1:'#c0392b',2:'#9a6e00',3:'#1a6b3a'};
  var BF={1:'rgba(192,57,43,0.78)',2:'rgba(154,110,0,0.78)',3:'rgba(26,107,58,0.78)'};
  var ZC={1:'z1',2:'z2',3:'z3'};
  var bY=iy(bench),iY=iy(iron);

  function ripple(el,e){
    var r=document.createElement('span');r.className='rpl';
    var rc=el.getBoundingClientRect(),sz=Math.max(rc.width,rc.height);
    r.style.cssText='width:'+sz+'px;height:'+sz+'px;left:'+(e.clientX-rc.left-sz/2)+'px;top:'+(e.clientY-rc.top-sz/2)+'px;';
    el.appendChild(r);setTimeout(function(){r.remove();},450);
  }

  var cHTML=comment?"<div class='cmnt on fade' id='cm'><div class='cmnt-ico'>üí¨</div><div class='cmnt-body'><div class='cmnt-lbl'>\u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439</div><div class='cmnt-txt'>"+comment+"</div></div></div>":"";

  R.innerHTML=
    "<div class='hdr'><div class='emp-name'>"+name+"</div><div class='emp-sub'>Profitability Dynamics</div></div>"+
    "<div class='body'>"+
      "<div class='left'>"+
        "<div class='pills'>"+
          "<div class='pill "+ZC[zones[0]]+" fade' id='p0' style='animation-delay:.05s'><div class='pill-lbl'>\u041f\u0435\u0440\u0432\u044b\u0439 \u043f\u0435\u0440\u0438\u043e\u0434</div><div class='pill-val "+ZC[zones[0]]+"'>"+fp(vals[0])+"</div></div>"+
          "<div class='pill "+ZC[zones[n-1]]+" fade' id='p1' style='animation-delay:.1s'><div class='pill-lbl'>\u041f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0439 \u043f\u0435\u0440\u0438\u043e\u0434</div><div class='pill-val "+ZC[zones[n-1]]+"'>"+fp(vals[n-1])+"</div></div>"+
        "</div>"+
        "<div class='chart-box'><canvas id='ch'></canvas></div>"+
      "</div>"+
      "<div class='right'>"+
        cHTML+
        "<div class='metrics'>"+
          "<div class='mrow'><div class='m fade' id='m0' style='animation-delay:.07s'><div class='ml'>\u0417\u041f</div><div class='mv "+(salHigh?'sh':'so')+"'>"+fm(sal)+"</div></div>"+
          "<div class='m fade' id='m1' style='animation-delay:.11s'><div class='ml'>\u0421\u0440\u0435\u0434\u043d\u044f\u044f \u0417\u041f</div><div class='mv'>"+fm(avgsal)+"</div></div></div>"+
          "<div class='mrow'><div class='m fade' id='m2' style='animation-delay:.15s'><div class='ml'>\u0421\u0442\u0430\u0440\u0442</div><div class='mv'>"+start+"</div></div>"+
          "<div class='m fade' id='m3' style='animation-delay:.19s'><div class='ml'>\u0421\u0442\u043e\u043f</div><div class='mv'>"+stop+"</div></div></div>"+
          "<div class='mrow s1'><div class='m fade' id='m4' style='animation-delay:.23s'><div class='ml'>\u0421\u043b\u0435\u0434\u0443\u044e\u0449\u0435\u0435 \u0440\u0435\u0432\u044c\u044e</div><div class='mv'>"+review+"</div></div></div>"+
          "<div class='mrow'><div class='m fade' id='m5' style='animation-delay:.27s'><div class='ml'>2nd Bench</div><span class='badge "+(bY?'y':'n')+"\'>"+( bY?'Yes':'No')+"</span></div>"+
          "<div class='m fade' id='m6' style='animation-delay:.31s'><div class='ml'>Iron List</div><span class='badge "+(iY?'y':'n')+"'>"+( iY?'Yes':'No')+"</span></div></div>"+
        "</div>"+
      "</div>"+
    "</div>";

  ['p0','p1','m0','m1','m2','m3','m4','m5','m6','cm'].forEach(function(id){
    var el=document.getElementById(id);
    if(el) el.addEventListener('click',function(e){ripple(el,e);});
  });

  // ‚îÄ‚îÄ CHART ‚îÄ‚îÄ
  var dlPlugin={
    id:'dl',
    afterDatasetsDraw:function(chart){
      var c=chart.ctx,ca=chart.chartArea; if(!ca)return;
      // font size based on available width per bar
      var barW=(ca.width||300)/Math.max(n,1);
      var sz=Math.max(9,Math.min(13,Math.floor(barW/3.5)));
      chart.getDatasetMeta(0).data.forEach(function(bar,i){
        c.save();
        c.font='bold '+sz+'px Arial';
        c.fillStyle=BC[zones[i]];
        c.textAlign='center';
        var yOff=vals[i]<0?14:-7;
        c.fillText(fp(vals[i]),bar.x,bar.y+yOff);
        c.restore();
      });
    }
  };

  var zeroPlugin={
    id:'zL',
    afterDraw:function(chart){
      var sc=chart.scales.y;if(!sc)return;
      var y0=sc.getPixelForValue(0),c=chart.ctx;
      c.save();c.beginPath();
      c.moveTo(chart.scales.x.left,y0);c.lineTo(chart.scales.x.right,y0);
      c.strokeStyle='rgba(1,61,126,0.18)';c.lineWidth=1.5;c.setLineDash([4,4]);
      c.stroke();c.restore();
    }
  };

  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–∞ —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ–≥—Ä–æ–º–Ω—ã—Ö –±–∞—Ä–æ–≤ –ø—Ä–∏ 1-2 —Ç–æ—á–∫–∞—Ö
  var maxThickness = n <= 3 ? 60 : n <= 6 ? 50 : undefined;

  new Chart(document.getElementById('ch').getContext('2d'),{
    type:'bar', plugins:[dlPlugin,zeroPlugin],
    data:{
      labels:labs,
      datasets:[{
        data:vals.map(function(v){return parseFloat((v*100).toFixed(4));}),
        backgroundColor:zones.map(function(z){return BF[z];}),
        borderColor:zones.map(function(z){return BC[z];}),
        borderWidth:0, borderRadius:6, borderSkipped:false,
        maxBarThickness: maxThickness
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{padding:{top:22,left:4,right:6,bottom:2}},
      animation:{
        duration:600,easing:'easeOutQuart',
        delay:function(ctx){return(ctx.dataIndex||0)*20;}
      },
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{label:function(item){return' '+fp(vals[item.dataIndex]);}},
          backgroundColor:'#013d7e',
          titleFont:{weight:'bold',size:12,family:'Arial'},
          bodyFont:{size:13,family:'Arial'},padding:10,cornerRadius:8
        }
      },
      scales:{
        x:{
          grid:{display:false},border:{display:false},
          ticks:{font:{size:9,family:'Arial',weight:'600'},color:'#8a9ab5',maxRotation:40,autoSkip:true,maxTicksLimit:14}
        },
        y:{display:false,grace:'22%'}
      }
    }
  });

  window.addEventListener('resize',function(){
    Chart.instances.forEach(function(c){c.resize();});
  });
})();
</script>
</body>
</html>