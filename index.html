<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: Segoe UI, Arial, sans-serif;
    background: #fff;
    padding: 20px;
    overflow: auto;
  }
  .wrap { display: flex; flex-direction: column; gap: 14px; }
  .hdr { border-bottom: 3px solid #013d7e; padding-bottom: 10px; }
  .hdr h2 { color: #013d7e; font-size: 20px; font-weight: 800; text-transform: uppercase; }
  .hdr p { color: #666; font-size: 13px; margin-top: 3px; }
  .chart-area { position: relative; width: 100%; height: 240px; background: #fafafa; border: 1px solid #e8e8e8; border-radius: 4px; }
  svg { width: 100%; height: 100%; }
  .tip {
    position: absolute; background: #013d7e; color: #fff;
    padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 700;
    pointer-events: none; display: none; white-space: nowrap;
    transform: translate(-50%, -110%);
  }
  .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  .sbox { background: #f4f4f4; border: 1px solid #e0e0e0; padding: 10px 14px; border-radius: 4px; }
  .slbl { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #888; margin-bottom: 3px; }
  .sval { font-size: 20px; font-weight: 900; }
  .pos { color: #2E7D32; } .neg { color: #C00000; } .warn { color: #C69200; } .def { color: #013d7e; }
  .empty { color: #999; font-size: 15px; padding: 20px; }
</style>
</head>
<body>
<div id="app"></div>
<script>
(function () {
  var params = new URLSearchParams(window.location.search);
  var name = params.get('name');
  var dataRaw = params.get('data');
  var app = document.getElementById('app');

  if (!name || !dataRaw) {
    app.innerHTML = "<p class='empty'>← Выбери строку в таблице</p>";
    return;
  }

  // Парсим data: "Янв-24:0.1200|Фев-24:0.2700|..."
  var RAW = dataRaw.split('|').map(function (s) {
    var parts = s.split(':');
    return { p: parts[0], r: parseFloat(parts[1]) || 0 };
  }).filter(function (d) { return d.p; });

  if (!RAW.length) {
    app.innerHTML = "<p class='empty'>Нет данных</p>";
    return;
  }

  var vals = RAW.map(function (d) { return d.r; });
  var labs = RAW.map(function (d) { return d.p; });
  var n = vals.length;
  var avg = vals.reduce(function (a, b) { return a + b; }, 0) / n;
  var first = vals[0];
  var last = vals[n - 1];

  function fmtPct(v) { return (v * 100).toFixed(1).replace('.', ',') + '%'; }
  function cls(v) { return v >= 0.10 ? 'pos' : v > 0 ? 'warn' : 'neg'; }

  var accentColor = last >= 0.1 ? '#2E7D32' : last > 0 ? '#C69200' : '#C00000';

  app.innerHTML =
    "<div class='wrap'>" +
      "<div class='hdr'>" +
        "<h2>" + name + "</h2>" +
        "<p>Динамика рентабельности • Все периоды</p>" +
      "</div>" +
      "<div class='chart-area' id='cw'><svg id='svg'></svg><div class='tip' id='tip'></div></div>" +
      "<div class='stats'>" +
        "<div class='sbox'><div class='slbl'>Первый период</div><div class='sval " + cls(first) + "'>" + fmtPct(first) + "</div></div>" +
        "<div class='sbox'><div class='slbl'>Последний период</div><div class='sval " + cls(last) + "'>" + fmtPct(last) + "</div></div>" +
        "<div class='sbox'><div class='slbl'>Среднее</div><div class='sval " + cls(avg) + "'>" + fmtPct(avg) + "</div></div>" +
      "</div>" +
    "</div>";

  var svg = document.getElementById('svg');
  var cw = document.getElementById('cw');
  var tip = document.getElementById('tip');
  var W = cw.clientWidth || 600;
  var H = cw.clientHeight || 240;
  var PAD = { t: 20, r: 20, b: 32, l: 52 };
  var CW = W - PAD.l - PAD.r;
  var CH = H - PAD.t - PAD.b;
  var minV = Math.min.apply(null, [0].concat(vals));
  var maxV = Math.max.apply(null, [0].concat(vals));
  var span = maxV - minV || 0.01;

  function xOf(i) { return PAD.l + (n === 1 ? CW / 2 : i / (n - 1) * CW); }
  function yOf(v) { return PAD.t + CH - ((v - minV) / span * CH); }
  var y0 = yOf(0);

  // Grid
  [-0.2,-0.1,0,0.1,0.2,0.3,0.4].filter(function(t){return t>=minV-0.05&&t<=maxV+0.05;}).forEach(function (t) {
    var y = yOf(t);
    var l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    l.setAttribute('x1', PAD.l); l.setAttribute('x2', W - PAD.r);
    l.setAttribute('y1', y); l.setAttribute('y2', y);
    l.setAttribute('stroke', t === 0 ? '#999' : '#e8e8e8');
    l.setAttribute('stroke-width', t === 0 ? '1.5' : '1');
    if (t !== 0) l.setAttribute('stroke-dasharray', '4,3');
    svg.appendChild(l);
    var tx = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    tx.setAttribute('x', PAD.l - 6); tx.setAttribute('y', y + 4);
    tx.setAttribute('text-anchor', 'end'); tx.setAttribute('font-size', '10'); tx.setAttribute('fill', '#999');
    tx.textContent = (t * 100).toFixed(0) + '%';
    svg.appendChild(tx);
  });

  // Gradient
  var defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  var grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
  grad.setAttribute('id', 'g'); grad.setAttribute('x1', '0'); grad.setAttribute('y1', '0');
  grad.setAttribute('x2', '0'); grad.setAttribute('y2', '1');
  var s1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  s1.setAttribute('offset', '0%'); s1.setAttribute('stop-color', accentColor); s1.setAttribute('stop-opacity', '0.3');
  var s2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  s2.setAttribute('offset', '100%'); s2.setAttribute('stop-color', accentColor); s2.setAttribute('stop-opacity', '0.02');
  grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad); svg.appendChild(defs);

  // Area
  var ap = 'M ' + xOf(0) + ' ' + y0;
  vals.forEach(function (v, i) { ap += ' L ' + xOf(i) + ' ' + yOf(v); });
  ap += ' L ' + xOf(n - 1) + ' ' + y0 + ' Z';
  var area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  area.setAttribute('d', ap); area.setAttribute('fill', 'url(#g)');
  svg.appendChild(area);

  // Line
  var lp = vals.map(function (v, i) { return (i === 0 ? 'M ' : 'L ') + xOf(i) + ' ' + yOf(v); }).join(' ');
  var line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  line.setAttribute('d', lp); line.setAttribute('fill', 'none');
  line.setAttribute('stroke', accentColor); line.setAttribute('stroke-width', '2.5');
  line.setAttribute('stroke-linejoin', 'round'); line.setAttribute('stroke-linecap', 'round');
  svg.appendChild(line);

  // Dots
  vals.forEach(function (v, i) {
    var x = xOf(i), y = yOf(v);
    var dc = v >= 0.10 ? '#2E7D32' : v > 0 ? '#C69200' : '#C00000';
    var c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    c.setAttribute('cx', x); c.setAttribute('cy', y); c.setAttribute('r', '4');
    c.setAttribute('fill', dc); c.setAttribute('stroke', '#fff'); c.setAttribute('stroke-width', '1.5');
    c.style.cursor = 'pointer';
    (function (xi, yi, li, vi) {
      c.addEventListener('mouseenter', function () {
        tip.style.display = 'block'; tip.style.left = xi + 'px'; tip.style.top = yi + 'px';
        tip.textContent = li + ': ' + fmtPct(vi);
      });
      c.addEventListener('mouseleave', function () { tip.style.display = 'none'; });
    })(x, y, labs[i], v);
    svg.appendChild(c);

    if (i === 0 || i === n - 1 || i % Math.max(1, Math.floor(n / 6)) === 0) {
      var xt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      xt.setAttribute('x', x); xt.setAttribute('y', H - PAD.b + 14);
      xt.setAttribute('text-anchor', 'middle'); xt.setAttribute('font-size', '9'); xt.setAttribute('fill', '#999');
      xt.textContent = labs[i];
      svg.appendChild(xt);
    }
  });
})();
</script>
</body>
</html>