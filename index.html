<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --blue:    #013d7e;
  --blue-md: #1a5fa8;
  --blue-lt: #e8f0fb;
  --white:   #ffffff;
  --bg:      #f0f4fb;
  --text:    #0d1b2e;
  --muted:   #7a8fa8;
  --red:     #c0392b;
  --yellow:  #b8860b;
  --green:   #1a6b3a;
  --card-shadow: 0 2px 12px rgba(1,61,126,0.10);
  --card-shadow-hover: 0 8px 32px rgba(1,61,126,0.20);
  --radius: 14px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { width: 100%; height: 100%; overflow: hidden; background: var(--bg); }

body {
  font-family: 'DM Sans', sans-serif;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  flex-shrink: 0;
}
.hdr-left { flex: 1; min-width: 0; }
.hdr h2 {
  font-family: 'DM Serif Display', serif;
  color: var(--blue);
  font-size: clamp(15px, 2.4vw, 22px);
  font-weight: 400;
  letter-spacing: -0.02em;
  line-height: 1.1;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.hdr-sub {
  font-size: clamp(9px, 1.1vw, 11px);
  color: var(--muted);
  margin-top: 3px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

/* ‚îÄ‚îÄ COMMENT ‚îÄ‚îÄ */
.comment-wrap { display: none; flex-shrink: 0; }
.comment-wrap.visible { display: block; }
.comment-card {
  background: var(--blue);
  border-radius: var(--radius);
  padding: 10px 16px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  box-shadow: var(--card-shadow);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.comment-card:hover { transform: translateY(-2px); box-shadow: var(--card-shadow-hover); }
.comment-card:active { transform: scale(1.02); }
.comment-icon {
  width: 28px; height: 28px; flex-shrink: 0;
  background: rgba(255,255,255,0.15);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
}
.comment-body { flex: 1; }
.comment-label {
  font-size: 9px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.12em; color: rgba(255,255,255,0.55); margin-bottom: 3px;
}
.comment-text { font-size: clamp(10px, 1.3vw, 13px); color: #fff; line-height: 1.4; font-weight: 400; }

/* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
.main-area {
  flex: 1;
  min-height: 0;
  display: grid;
  grid-template-columns: 1fr 340px;
  grid-template-rows: 1fr;
  gap: 10px;
}

/* ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ */
.right-panel {
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 0;
}

/* –î–≤–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ */
.rent-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

/* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ */
.card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 10px 14px;
  box-shadow: var(--card-shadow);
  cursor: pointer;
  transition: transform 0.22s cubic-bezier(.34,1.56,.64,1), box-shadow 0.22s;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  user-select: none;
}
.card:hover { transform: translateY(-3px) scale(1.03); box-shadow: var(--card-shadow-hover); }
.card:active { transform: scale(1.06); }
.card.active-pop { transform: scale(1.07); box-shadow: 0 12px 40px rgba(1,61,126,0.25); }

.card-lbl {
  font-size: clamp(7px, 0.85vw, 10px);
  font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--muted);
  margin-bottom: 4px;
}
.card-val {
  font-family: 'DM Serif Display', serif;
  font-size: clamp(18px, 3vw, 30px);
  line-height: 1;
  color: var(--text);
}
.card-val.z1 { color: var(--red); }
.card-val.z2 { color: var(--yellow); }
.card-val.z3 { color: var(--green); }

/* –ò–Ω—Ñ–æ-–∫–∞—Ä—Ç–æ—á–∫–∏ 2x3 */
.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  flex: 1;
}

.icard {
  background: var(--white);
  border-radius: var(--radius);
  padding: 10px 14px;
  box-shadow: var(--card-shadow);
  cursor: pointer;
  transition: transform 0.22s cubic-bezier(.34,1.56,.64,1), box-shadow 0.22s;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  justify-content: center;
  user-select: none;
}
.icard:hover { transform: translateY(-3px) scale(1.03); box-shadow: var(--card-shadow-hover); }
.icard:active { transform: scale(1.06); }

.icard-lbl {
  font-size: clamp(7px, 0.85vw, 9px);
  font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--muted);
  margin-bottom: 3px;
}
.icard-val {
  font-family: 'DM Serif Display', serif;
  font-size: clamp(13px, 1.8vw, 19px);
  color: var(--text);
  line-height: 1.1;
}
.icard-val.sal-high { color: var(--red); }
.icard-val.sal-ok   { color: var(--green); }
.icard-val.flag-yes { color: var(--red); }
.icard-val.flag-no  { color: var(--muted); }

/* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –¥–≤—É–º—è –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (bench + iron) */
.icard-double {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
  padding: 0;
  overflow: hidden;
}
.icard-half {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10px 8px;
}
.icard-half:first-child {
  border-right: 1px solid var(--blue-lt);
}

/* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
.chart-wrap {
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--card-shadow);
  padding: 14px 14px 10px 14px;
  position: relative;
  min-height: 0;
  overflow: hidden;
}
.chart-wrap canvas {
  position: absolute;
  top: 14px; left: 14px;
  right: 14px; bottom: 10px;
  width: calc(100% - 28px) !important;
  height: calc(100% - 24px) !important;
}

/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–æ–ª–æ—Å–∞ —Å–≤–µ—Ä—Ö—É –∫–∞—Ä—Ç–æ—á–∫–∏ */
.card::before, .icard::before {
  content: '';
  position: absolute;
  top: 0; left: 16px; right: 16px;
  height: 2px;
  background: linear-gradient(90deg, var(--blue-lt), var(--blue-md), var(--blue-lt));
  border-radius: 0 0 2px 2px;
  opacity: 0;
  transition: opacity 0.22s;
}
.card { position: relative; }
.icard { position: relative; }
.card:hover::before, .icard:hover::before { opacity: 1; }

.empty { color: var(--muted); font-size: 14px; text-align: center; margin-top: 40px; }
</style>
</head>
<body>
<div id="app" style="display:contents"></div>
<script>
(function(){
  var p       = new URLSearchParams(window.location.search);
  var name    = p.get('name');
  var dataRaw = p.get('data');
  var comment = p.get('comment') || '';
  var sal     = p.get('sal')     || '';
  var avgsal  = p.get('avgsal')  || '';
  var salHigh = p.get('salhigh') === '1';
  var start   = p.get('start')   || '\u2014';
  var stop    = p.get('stop')    || '\u2014';
  var review  = p.get('review')  || '\u2014';
  var bench   = p.get('bench')   || 'No';
  var iron    = p.get('iron')    || 'No';
  var app     = document.getElementById('app');

  if(!name || !dataRaw){
    document.body.innerHTML = "<p class='empty'>\u2190 \u0412\u044b\u0431\u0435\u0440\u0438 \u0441\u0442\u0440\u043e\u043a\u0443 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 Power BI</p>";
    return;
  }

  var RAW = dataRaw.split('|').map(function(s){
    var lc=s.lastIndexOf(':'), sc=s.lastIndexOf(':',lc-1);
    return { p:s.substring(0,sc), r:parseFloat(s.substring(sc+1,lc))||0, z:parseInt(s.substring(lc+1))||1 };
  }).filter(function(d){ return d.p; });

  if(!RAW.length){ document.body.innerHTML="<p class='empty'>\u041d\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0445</p>"; return; }

  var vals  = RAW.map(function(d){ return d.r; });
  var labs  = RAW.map(function(d){ return d.p; });
  var zones = RAW.map(function(d){ return d.z; });
  var n     = vals.length;

  function fmtPct(v){
    var pct=v*100;
    return (pct<0?'-':'')+Math.abs(pct).toFixed(1).replace('.',',')+'\u0025';
  }
  function fmtMoney(v){
    if(!v||v==='0') return '\u2014';
    return '$\u00a0'+parseInt(v).toLocaleString('ru-RU');
  }
  function isYes(v){ return v&&(v.toLowerCase()==='yes'||v==='1'||v.toLowerCase()==='\u0434\u0430'); }

  var COLORS = {1:'rgba(192,57,43,0.80)', 2:'rgba(184,134,11,0.80)', 3:'rgba(26,107,58,0.80)'};
  var BORDER = {1:'#c0392b', 2:'#b8860b', 3:'#1a6b3a'};
  var ZCLS   = {1:'z1', 2:'z2', 3:'z3'};
  function zOf(v){ return v>=0.10?3:v>0?2:1; }

  var benchYes = isYes(bench);
  var ironYes  = isYes(iron);

  // Build DOM
  var commentHTML = comment
    ? "<div class='comment-wrap visible'><div class='comment-card' onclick='popCard(this)'><div class='comment-icon'>üí¨</div><div class='comment-body'><div class='comment-label'>\u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439</div><div class='comment-text'>"+comment+"</div></div></div></div>"
    : "";

  app.innerHTML =
    // Header
    "<div class='hdr'><div class='hdr-left'><h2>"+name+"</h2><div class='hdr-sub'>Profitability Dynamics</div></div></div>"+
    commentHTML+
    "<div class='main-area'>"+
      // LEFT ‚Äî chart
      "<div class='chart-wrap'><canvas id='ch'></canvas></div>"+
      // RIGHT ‚Äî cards
      "<div class='right-panel'>"+
        // Rent cards (first + last only)
        "<div class='rent-row'>"+
          "<div class='card' onclick='popCard(this)'><div class='card-lbl'>\u041f\u0435\u0440\u0432\u044b\u0439 \u043f\u0435\u0440\u0438\u043e\u0434</div><div class='card-val "+ZCLS[zones[0]]+"'>"+fmtPct(vals[0])+"</div></div>"+
          "<div class='card' onclick='popCard(this)'><div class='card-lbl'>\u041f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0439 \u043f\u0435\u0440\u0438\u043e\u0434</div><div class='card-val "+ZCLS[zones[n-1]]+"'>"+fmtPct(vals[n-1])+"</div></div>"+
        "</div>"+
        // Info cards
        "<div class='info-grid'>"+
          "<div class='icard' onclick='popCard(this)'><div class='icard-lbl'>\u0417\u041f</div><div class='icard-val "+(salHigh?'sal-high':'sal-ok')+"'>"+fmtMoney(sal)+"</div></div>"+
          "<div class='icard' onclick='popCard(this)'><div class='icard-lbl'>\u0421\u0440\u0435\u0434\u043d\u044f\u044f \u0417\u041f</div><div class='icard-val'>"+fmtMoney(avgsal)+"</div></div>"+
          "<div class='icard' onclick='popCard(this)'><div class='icard-lbl'>\u0421\u0442\u0430\u0440\u0442</div><div class='icard-val'>"+start+"</div></div>"+
          "<div class='icard' onclick='popCard(this)'><div class='icard-lbl'>\u0421\u0442\u043e\u043f</div><div class='icard-val'>"+stop+"</div></div>"+
          "<div class='icard' onclick='popCard(this)'><div class='icard-lbl'>\u0420\u0435\u0432\u044c\u044e</div><div class='icard-val'>"+review+"</div></div>"+
          "<div class='icard icard-double' onclick='popCard(this)'>"+
            "<div class='icard-half'><div class='icard-lbl'>2nd Bench</div><div class='icard-val "+(benchYes?'flag-yes':'flag-no')+"\'>"+( benchYes?'Yes':'No')+"</div></div>"+
            "<div class='icard-half'><div class='icard-lbl'>Iron List</div><div class='icard-val "+(ironYes?'flag-yes':'flag-no')+"'>"+( ironYes?'Yes':'No')+"</div></div>"+
          "</div>"+
        "</div>"+
      "</div>"+
    "</div>";

  // Pop animation
  window.popCard = function(el){
    el.classList.add('active-pop');
    setTimeout(function(){ el.classList.remove('active-pop'); }, 350);
  };

  // Chart ‚Äî area + line (–∫—Ä–∞—Å–∏–≤–æ –ø—Ä–∏ –æ—Ç—Ä–∏—Ü. –∑–Ω–∞—á–µ–Ω–∏—è—Ö)
  var dlPlugin = {
    id:'dl',
    afterDatasetsDraw:function(chart){
      var c2=chart.ctx;
      chart.getDatasetMeta(0).data.forEach(function(pt,i){
        c2.save();
        var w=chart.chartArea.width||400;
        var sz=Math.max(8,Math.min(11,Math.floor(w/(n*4.5))));
        c2.font='600 '+sz+'px DM Sans';
        c2.fillStyle=BORDER[zones[i]];
        c2.textAlign='center';
        c2.fillText(fmtPct(vals[i]),pt.x,pt.y-8);
        c2.restore();
      });
    }
  };

  // zero-line plugin
  var zeroPlugin = {
    id:'zeroLine',
    afterDraw:function(chart){
      if(!chart.scales.y) return;
      var y0=chart.scales.y.getPixelForValue(0);
      var c2=chart.ctx, xl=chart.scales.x.left, xr=chart.scales.x.right;
      c2.save();
      c2.beginPath(); c2.moveTo(xl,y0); c2.lineTo(xr,y0);
      c2.strokeStyle='rgba(1,61,126,0.25)'; c2.lineWidth=1.5;
      c2.setLineDash([]);
      c2.stroke(); c2.restore();
    }
  };

  var gradPlugin = {
    id:'areaGrad',
    beforeDatasetsDraw:function(chart){
      var ctx2=chart.ctx, ca=chart.chartArea;
      if(!ca) return;
      var y0=chart.scales.y.getPixelForValue(0);
      // above zero gradient
      var gUp=ctx2.createLinearGradient(0,ca.top,0,y0);
      gUp.addColorStop(0,'rgba(1,61,126,0.18)');
      gUp.addColorStop(1,'rgba(1,61,126,0.02)');
      // below zero gradient
      var gDn=ctx2.createLinearGradient(0,y0,0,ca.bottom);
      gDn.addColorStop(0,'rgba(192,57,43,0.04)');
      gDn.addColorStop(1,'rgba(192,57,43,0.15)');
      chart.data.datasets[0]._gradUp=gUp;
      chart.data.datasets[0]._gradDn=gDn;
      chart.data.datasets[0]._y0=y0;
    }
  };

  new Chart(document.getElementById('ch').getContext('2d'),{
    type:'line',
    plugins:[dlPlugin, zeroPlugin, gradPlugin],
    data:{
      labels:labs,
      datasets:[{
        data:vals.map(function(v){ return parseFloat((v*100).toFixed(4)); }),
        borderColor:'#013d7e',
        borderWidth:2.5,
        pointBackgroundColor:zones.map(function(z){ return BORDER[z]; }),
        pointBorderColor:'#fff',
        pointBorderWidth:2,
        pointRadius:5,
        pointHoverRadius:7,
        tension:0.35,
        fill:true,
        backgroundColor:function(ctx3){
          var chart=ctx3.chart;
          var ds=chart.data.datasets[0];
          if(!ds||!ds._gradUp) return 'rgba(1,61,126,0.10)';
          // dual fill ‚Äî use up gradient for positive area
          return ds._gradUp;
        }
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:22, left:4, right:8, bottom:4 } },
      animation:{ duration:600, easing:'easeOutQuart' },
      plugins:{
        legend:{ display:false },
        tooltip:{
          callbacks:{
            label:function(item){ return ' '+fmtPct(vals[item.dataIndex]); }
          },
          backgroundColor:'#013d7e',
          titleFont:{ weight:'700', size:11, family:'DM Sans' },
          bodyFont:{ size:12, family:'DM Serif Display' },
          padding:10, cornerRadius:8
        }
      },
      scales:{
        x:{
          grid:{ display:false },
          border:{ display:false },
          ticks:{ font:{ size:9, family:'DM Sans' }, color:'#7a8fa8', maxRotation:40, autoSkip:true, maxTicksLimit:16 }
        },
        y:{
          display:false,
          grace:'15%'
        }
      }
    }
  });

  window.addEventListener('resize',function(){
    Chart.instances.forEach(function(c){ c.resize(); });
  });
})();
</script>
</body>
</html>