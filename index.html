<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html { width:100%; height:100%; }
body {
  width:100%; height:100%;
  background:#fff;
  font-family: Arial, Helvetica, sans-serif;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  text-rendering: geometricPrecision;
  -webkit-font-smoothing: subpixel-antialiased;
}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê (–ö–æ–º–ø–∞–∫—Ç–Ω–µ–µ) */
.hdr {
  background: linear-gradient(135deg, #013d7e 0%, #1a5fa8 55%, #2272c3 100%);
  padding: 10px 15px 8px;
  flex-shrink: 0;
}
.emp-name {
  font-size: clamp(18px, 2.8vw, 26px); /* –£–≤–µ–ª–∏—á–µ–Ω–æ */
  font-weight: 900; color: #fff;
  line-height: 1.1;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.emp-sub {
  font-size: 11px; /* –£–≤–µ–ª–∏—á–µ–Ω–æ */
  color: rgba(255,255,255,0.65);
  letter-spacing: 0.1em; text-transform: uppercase;
  margin-top: 2px; font-weight: 700;
}

/* ‚ïê‚ïê‚ïê BODY ‚ïê‚ïê‚ïê */
.body {
  flex:1; min-height:0;
  display: grid;
  grid-template-columns: 1fr 320px; /* –ù–µ–º–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–∏–ª –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤ */
  grid-template-rows: 1fr;
}

/* ‚ïê‚ïê‚ïê LEFT ‚ïê‚ïê‚ïê */
.left {
  padding: 10px;
  display: flex; flex-direction: column; gap: 8px;
  border-right: 1px solid #edf2f9;
  min-width: 0; min-height: 0;
}

.pills { display:flex; gap:8px; }
.pill {
  flex:1; background:#f5f8fd;
  border-radius:8px; padding:10px;
  text-align:center;
  border-bottom: 4px solid transparent;
}
.pill.z1 { border-bottom-color: #c0392b; }
.pill.z2 { border-bottom-color: #9a6e00; }
.pill.z3 { border-bottom-color: #1a6b3a; }

.pill-lbl {
  font-size: 11px; font-weight: 800;
  text-transform: uppercase; color: #8a9ab5; margin-bottom: 2px;
}
.pill-val {
  font-size: clamp(28px, 4.5vw, 46px); /* –£–≤–µ–ª–∏—á–µ–Ω–æ */
  font-weight: 900; line-height: 1;
}
.pill-val.z1 { color:#c0392b; }
.pill-val.z2 { color:#9a6e00; }
.pill-val.z3 { color:#1a6b3a; }

.chart-box { flex:1; min-height:0; position:relative; margin-top: 5px; }

/* ‚ïê‚ïê‚ïê RIGHT ‚ïê‚ïê‚ïê */
.right {
  padding: 10px;
  display: flex; flex-direction: column; gap: 8px;
  background: #fafbfd;
  min-width: 0;
}

.cmnt {
  background: linear-gradient(135deg, #013d7e, #1a5fa8);
  border-radius: 8px; padding: 10px;
  display: none; gap: 8px; 
}
.cmnt.on { display: flex; }
.cmnt-ico { font-size:18px; }
.cmnt-lbl { font-size:10px; font-weight:800; text-transform:uppercase; color:rgba(255,255,255,0.6); margin-bottom:2px; }
.cmnt-txt { font-size: 14px; color:#fff; line-height: 1.3; }

.metrics { display:flex; flex-direction:column; gap:6px; flex:1; }
.mrow { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.mrow.s1 { grid-template-columns:1fr; }

.m {
  background:#fff; border-radius:8px;
  padding:12px;
  border:1px solid #edf2f9;
}
.ml { font-size: 11px; font-weight: 800; text-transform: uppercase; color:#8a9ab5; margin-bottom: 4px; }
.mv { font-size: 20px; font-weight: 900; color:#0d1b2e; line-height: 1; }
.mv.sh { color:#c0392b; }
.mv.so { color:#1a6b3a; }

.badge {
  display:inline-flex; padding:4px 12px; border-radius:6px;
  font-size: 16px; font-weight: 900;
}
.badge.y { background:#fde8e6; color:#c0392b; }
.badge.n { background:#f0f2f5; color:#8a9ab5; }

.empty { color:#8a9ab5; font-size:16px; text-align:center; padding:40px; }
</style>
</head>
<body>
<div id="R" style="display:contents"></div>
<script>
(function(){
  var q=new URLSearchParams(location.search);
  var name=q.get('name'), data=q.get('data');
  var comment=q.get('comment')||'';
  var sal=q.get('sal')||'', avgsal=q.get('avgsal')||'';
  var salHigh=q.get('salhigh')==='1';
  var start=q.get('start')||'\u2014', stop=q.get('stop')||'\u2014';
  var review=q.get('review')||'\u2014';
  var bench=q.get('bench')||'No', iron=q.get('iron')||'No';
  var R=document.getElementById('R');

  if(!name||!data){ document.body.innerHTML="<p class='empty'>\u2190 \u0412\u044b\u0431\u0435\u0440\u0438 \u0441\u0442\u0440\u043e\u043a\u0443</p>"; return; }

  var RAW=data.split('|').map(function(s){
    var lc=s.lastIndexOf(':'),sc=s.lastIndexOf(':',lc-1);
    return{p:s.substring(0,sc),r:parseFloat(s.substring(sc+1,lc))||0,z:parseInt(s.substring(lc+1))||1};
  }).filter(function(d){return d.p;});
  
  if(!RAW.length){document.body.innerHTML="<p class='empty'>\u041d\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0445</p>";return;}

  function fp(v){ var p=v*100; return(p<0?'-':'')+Math.abs(p).toFixed(1).replace('.',',')+'\u0025'; }
  function fm(v){ if(!v||v==='0')return'\u2014'; return '$\u00a0'+parseInt(v).toLocaleString('ru-RU'); }
  function iy(v){ return v&&(v.toLowerCase()==='yes'||v==='1'||v.toLowerCase()==='\u0434\u0430'); }

  var MO_RU=['\u044f\u043d\u0432','\u0444\u0435\u0432','\u043c\u0430\u0440','\u0430\u043f\u0440','\u043c\u0430\u0439','\u0438\u044e\u043d','\u0438\u044e\u043b','\u0430\u0432\u0433','\u0441\u0435\u043d','\u043e\u043a\u0442','\u043d\u043e\u044f','\u0434\u0435\u043a'];
  var MO_EN=['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
  function fmtLabel(s){
    if(!s) return s;
    var m1=s.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
    if(m1){ var mo=parseInt(m1[2],10)-1; var yr=m1[3].length===4?m1[3].slice(2):m1[3]; return MO_RU[mo]+'-'+yr; }
    var m2=s.match(/^([a-zA-Z]{3})[\s\-](\d{2,4})$/i);
    if(m2){ var idx=MO_EN.indexOf(m2[1].toLowerCase()); var yr2=m2[2].length===4?m2[2].slice(2):m2[2]; return(idx>=0?MO_RU[idx]:m2[1].toLowerCase())+'-'+yr2; }
    return s;
  }

  var vals=RAW.map(function(d){return d.r;});
  var labs=RAW.map(function(d){return fmtLabel(d.p);});
  var zones=RAW.map(function(d){return d.z;});
  var n=vals.length;

  var BC={1:'#c0392b',2:'#9a6e00',3:'#1a6b3a'};
  var BF={1:'rgba(192,57,43,0.85)',2:'rgba(154,110,0,0.85)',3:'rgba(26,107,58,0.85)'};
  var ZC={1:'z1',2:'z2',3:'z3'};
  var bY=iy(bench),iY=iy(iron);

  var cHTML=comment?"<div class='cmnt on' id='cm'><div class='cmnt-ico'>üí¨</div><div class='cmnt-body'><div class='cmnt-lbl'>\u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439</div><div class='cmnt-txt'>"+comment+"</div></div></div>":"";

  R.innerHTML=
    "<div class='hdr'><div class='emp-name'>"+name+"</div><div class='emp-sub'>Profitability Dynamics</div></div>"+
    "<div class='body'>"+
      "<div class='left'>"+
        "<div class='pills'>"+
          "<div class='pill "+ZC[zones[0]]+"' id='p0'><div class='pill-lbl'>\u041f\u0435\u0440\u0432\u044b\u0439 \u043f\u0435\u0440\u0438\u043e\u0434</div><div class='pill-val "+ZC[zones[0]]+"'>"+fp(vals[0])+"</div></div>"+
          "<div class='pill "+ZC[zones[n-1]]+"' id='p1'><div class='pill-lbl'>\u041f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0439 \u043f\u0435\u0440\u0438\u043e\u0434</div><div class='pill-val "+ZC[zones[n-1]]+"'>"+fp(vals[n-1])+"</div></div>"+
        "</div>"+
        "<div class='chart-box'><canvas id='ch'></canvas></div>"+
      "</div>"+
      "<div class='right'>"+
        cHTML+
        "<div class='metrics'>"+
          "<div class='mrow'><div class='m' id='m0'><div class='ml'>\u0417\u041f</div><div class='mv "+(salHigh?'sh':'so')+"'>"+fm(sal)+"</div></div>"+
          "<div class='m' id='m1'><div class='ml'>\u0421\u0440\u0435\u0434\u043d\u044f\u044f \u0417\u041f</div><div class='mv'>"+fm(avgsal)+"</div></div></div>"+
          "<div class='mrow'><div class='m' id='m2'><div class='ml'>\u0421\u0442\u0430\u0440\u0442</div><div class='mv'>"+start+"</div></div>"+
          "<div class='m' id='m3'><div class='ml'>\u0421\u0442\u043e\u043f</div><div class='mv'>"+stop+"</div></div></div>"+
          "<div class='mrow s1'><div class='m' id='m4'><div class='ml'>\u0421\u043b\u0435\u0434\u0443\u044e\u0449\u0435\u0435 \u0440\u0435\u0432\u044c\u044e</div><div class='mv'>"+review+"</div></div></div>"+
          "<div class='mrow'><div class='m' id='m5'><div class='ml'>2nd Bench</div><span class='badge "+(bY?'y':'n')+"\'>"+( bY?'Yes':'No')+"</span></div>"+
          "<div class='m' id='m6'><div class='ml'>Iron List</div><span class='badge "+(iY?'y':'n')+"'>"+( iY?'Yes':'No')+"</span></div></div>"+
        "</div>"+
      "</div>"+
    "</div>";

  // ‚îÄ‚îÄ CHART ‚îÄ‚îÄ
  var dlPlugin={
    id:'dl',
    afterDatasetsDraw:function(chart){
      var c=chart.ctx, ca=chart.chartArea; if(!ca)return;
      var barW=(ca.width||300)/Math.max(n,1);
      var sz=Math.max(10,Math.min(14,Math.floor(barW/3))); // –®—Ä–∏—Ñ—Ç –º–µ—Ç–æ–∫ –≤ –≥—Ä–∞—Ñ–∏–∫–µ —á—É—Ç—å –±–æ–ª—å—à–µ
      chart.getDatasetMeta(0).data.forEach(function(bar,i){
        c.save();
        c.font='bold '+sz+'px Arial';
        c.fillStyle=BC[zones[i]];
        c.textAlign='center';
        var yOff=vals[i]<0?16:-8;
        c.fillText(fp(vals[i]),bar.x,bar.y+yOff);
        c.restore();
      });
    }
  };

  var zeroPlugin={
    id:'zL',
    afterDraw:function(chart){
      var sc=chart.scales.y;if(!sc)return;
      var y0=sc.getPixelForValue(0),c=chart.ctx;
      c.save();c.beginPath();
      c.moveTo(chart.scales.x.left,y0);c.lineTo(chart.scales.x.right,y0);
      c.strokeStyle='rgba(1,61,126,0.2)';c.lineWidth=1.5;c.setLineDash([4,4]);
      c.stroke();c.restore();
    }
  };

  new Chart(document.getElementById('ch').getContext('2d'),{
    type:'bar', plugins:[dlPlugin,zeroPlugin],
    data:{
      labels:labs,
      datasets:[{
        data:vals.map(function(v){return parseFloat((v*100).toFixed(4));}),
        backgroundColor:zones.map(function(z){return BF[z];}),
        borderWidth:0, borderRadius:4, borderSkipped:false,
        maxBarThickness: 65
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{padding:{top:25,left:5,right:5,bottom:5}},
      animation: false, // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:'#013d7e',
          titleFont:{size:13},
          bodyFont:{size:14},
          padding:10
        }
      },
      scales:{
        x:{
          grid:{display:false},border:{display:false},
          ticks:{font:{size:11,weight:'600'},color:'#8a9ab5',maxRotation:0}
        },
        y:{display:false,grace:'25%'}
      }
    }
  });
})();
</script>
</body>
</html>