<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html { width:100%; height:100%; }
body {
  width:100%; height:100%;
  background:#fff;
  font-family: Arial, Helvetica, sans-serif;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  text-rendering: geometricPrecision;
  -webkit-font-smoothing: subpixel-antialiased;
}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.hdr {
  background: linear-gradient(135deg, #013d7e 0%, #1a5fa8 55%, #2272c3 100%);
  padding: 10px 15px 8px;
  flex-shrink: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.hdr-info { min-width: 0; }
.emp-name {
  font-size: clamp(18px, 2.8vw, 26px);
  font-weight: 900; color: #fff;
  line-height: 1.1;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.emp-sub {
  font-size: 11px;
  color: rgba(255,255,255,0.65);
  letter-spacing: 0.1em; text-transform: uppercase;
  margin-top: 2px; font-weight: 700;
}

/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ */
.lang-sw {
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.3);
  color: #fff;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 800;
  cursor: pointer;
  transition: background 0.2s;
}
.lang-sw:hover { background: rgba(255,255,255,0.25); }

/* ‚ïê‚ïê‚ïê BODY ‚ïê‚ïê‚ïê */
.body {
  flex:1; min-height:0;
  display: grid;
  grid-template-columns: 1fr 320px;
  grid-template-rows: 1fr;
}

.left {
  padding: 10px;
  display: flex; flex-direction: column; gap: 8px;
  border-right: 1px solid #edf2f9;
  min-width: 0; min-height: 0;
}

.pills { display:flex; gap:8px; }
.pill {
  flex:1; background:#f5f8fd;
  border-radius:8px; padding:10px;
  text-align:center;
  border-bottom: 4px solid transparent;
}
.pill.z1 { border-bottom-color: #c0392b; }
.pill.z2 { border-bottom-color: #9a6e00; }
.pill.z3 { border-bottom-color: #1a6b3a; }

.pill-lbl {
  font-size: 11px; font-weight: 800;
  text-transform: uppercase; color: #8a9ab5; margin-bottom: 2px;
}
.pill-val {
  font-size: clamp(28px, 4.5vw, 46px);
  font-weight: 900; line-height: 1;
}
.pill-val.z1 { color:#c0392b; }
.pill-val.z2 { color:#9a6e00; }
.pill-val.z3 { color:#1a6b3a; }

.chart-box { flex:1; min-height:0; position:relative; margin-top: 5px; }

.right {
  padding: 10px;
  display: flex; flex-direction: column; gap: 8px;
  background: #fafbfd;
  min-width: 0;
}

.cmnt {
  background: linear-gradient(135deg, #013d7e, #1a5fa8);
  border-radius: 8px; padding: 10px;
  display: none; gap: 8px; 
}
.cmnt.on { display: flex; }
.cmnt-ico { font-size:18px; }
.cmnt-lbl { font-size:10px; font-weight:800; text-transform:uppercase; color:rgba(255,255,255,0.6); margin-bottom:2px; }
.cmnt-txt { font-size: 14px; color:#fff; line-height: 1.3; }

.metrics { display:flex; flex-direction:column; gap:6px; flex:1; }
.mrow { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
.mrow.s1 { grid-template-columns:1fr; }

.m {
  background:#fff; border-radius:8px;
  padding:12px;
  border:1px solid #edf2f9;
}
.ml { font-size: 11px; font-weight: 800; text-transform: uppercase; color:#8a9ab5; margin-bottom: 4px; }
.mv { font-size: 20px; font-weight: 900; color:#0d1b2e; line-height: 1; }
.mv.sh { color:#c0392b; }
.mv.so { color:#1a6b3a; }

.badge {
  display:inline-flex; padding:4px 12px; border-radius:6px;
  font-size: 16px; font-weight: 900;
}
.badge.y { background:#fde8e6; color:#c0392b; }
.badge.n { background:#f0f2f5; color:#8a9ab5; }

.empty { color:#8a9ab5; font-size:16px; text-align:center; padding:40px; }
</style>
</head>
<body>
<div id="R" style="display:contents"></div>
<script>
(function(){
  // –í–•–û–î–ù–ê–Ø –ß–ê–°–¢–¨ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  var q=new URLSearchParams(location.search);
  var name=q.get('name'), data=q.get('data');
  var comment=q.get('comment')||'';
  var sal=q.get('sal')||'', avgsal=q.get('avgsal')||'';
  var salHigh=q.get('salhigh')==='1';
  var start=q.get('start')||'\u2014', stop=q.get('stop')||'\u2014';
  var review=q.get('review')||'\u2014';
  var bench=q.get('bench')||'No', iron=q.get('iron')||'No';
  var R=document.getElementById('R');

  var currentLang = (q.get('lang') || 'ru').toLowerCase();

  if(!name||!data){ 
    R.innerHTML="<p class='empty'>" + (currentLang==='ru'?'\u2190 \u0412\u044b\u0431\u0435\u0440\u0438 \u0441\u0442\u0440\u043e\u043a\u0443':'\u2190 Select a row') + "</p>"; 
    return; 
  }

  var RAW=data.split('|').map(function(s){
    var lc=s.lastIndexOf(':'),sc=s.lastIndexOf(':',lc-1);
    return{p:s.substring(0,sc),r:parseFloat(s.substring(sc+1,lc))||0,z:parseInt(s.substring(lc+1))||1};
  }).filter(function(d){return d.p;});
  
  if(!RAW.length){
    R.innerHTML="<p class='empty'>" + (currentLang==='ru'?'\u041d\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0445':'No data') + "</p>";
    return;
  }

  // –ü–µ—Ä–µ–≤–æ–¥—ã
  var T = {
    ru: {
      dyn: 'Profitability Dynamics',
      first: '–ü–µ—Ä–≤—ã–π –ø–µ—Ä–∏–æ–¥',
      last: '–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥',
      comm: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
      sal: '–ó–ü',
      avg: '–°—Ä–µ–¥–Ω—è—è –ó–ü',
      start: '–°—Ç–∞—Ä—Ç',
      stop: '–°—Ç–æ–ø',
      review: '–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Ä–µ–≤—å—é',
      bench: '2nd Bench',
      iron: 'Iron List',
      yes: '–î–∞',
      no: '–ù–µ—Ç'
    },
    en: {
      dyn: 'Profitability Dynamics',
      first: 'First Period',
      last: 'Last Period',
      comm: 'Comment',
      sal: 'Salary',
      avg: 'Avg Salary',
      start: 'Start',
      stop: 'Stop',
      review: 'Last Review',
      bench: '2nd Bench',
      iron: 'Iron List',
      yes: 'Yes',
      no: 'No'
    }
  };

  function fp(v, lang){ 
    var p=v*100; 
    var res = Math.abs(p).toFixed(1);
    if(lang === 'ru') res = res.replace('.', ',');
    return(p<0?'-':'')+res+'\u0025'; 
  }
  function fm(v, lang){ 
    if(!v||v==='0')return'\u2014'; 
    var num = parseInt(v).toLocaleString(lang === 'ru' ? 'ru-RU' : 'en-US');
    return lang === 'ru' ? '$\u00a0' + num : '$' + num;
  }
  function iy(v){ return v&&(v.toLowerCase()==='yes'||v==='1'||v.toLowerCase()==='\u0434\u0430'); }

  var MO_RU=['\u044f\u043d\u0432','\u0444\u0435\u0432','\u043c\u0430\u0440','\u0430\u043f\u0440','\u043c\u0430\u0439','\u0438\u044e\u043d','\u0438\u044e\u043b','\u0430\u0432\u0433','\u0441\u0435\u043d','\u043e\u043a\u0442','\u043d\u043e\u044f','\u0434\u0435\u043a'];
  var MO_EN=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  function fmtLabel(s, lang){
    if(!s) return s;
    var m1=s.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
    if(m1){ 
      var mo=parseInt(m1[2],10)-1; 
      var yr=m1[3].length===4?m1[3].slice(2):m1[3]; 
      return (lang==='ru'?MO_RU[mo]:MO_EN[mo])+'-'+yr; 
    }
    return s;
  }

  var vals=RAW.map(function(d){return d.r;});
  var zones=RAW.map(function(d){return d.z;});
  var n=vals.length;
  var BC={1:'#c0392b',2:'#9a6e00',3:'#1a6b3a'};
  var BF={1:'rgba(192,57,43,0.85)',2:'rgba(154,110,0,0.85)',3:'rgba(26,107,58,0.85)'};
  var ZC={1:'z1',2:'z2',3:'z3'};
  var bY=iy(bench),iY=iy(iron);

  function render(lang) {
    var txt = T[lang];
    var labs = RAW.map(function(d){return fmtLabel(d.p, lang);});
    var cHTML = comment ? "<div class='cmnt on'><div class='cmnt-ico'>üí¨</div><div class='cmnt-body'><div class='cmnt-lbl'>"+txt.comm+"</div><div class='cmnt-txt'>"+comment+"</div></div></div>" : "";

    R.innerHTML=
      "<div class='hdr'>" +
        "<div class='hdr-info'><div class='emp-name'>"+name+"</div><div class='emp-sub'>"+txt.dyn+"</div></div>" +
        "<button class='lang-sw' id='lsw'>"+(lang==='ru'?'RU':'EN')+"</button>" +
      "</div>"+
      "<div class='body'>"+
        "<div class='left'>"+
          "<div class='pills'>"+
            "<div class='pill "+ZC[zones[0]]+"'><div class='pill-lbl'>"+txt.first+"</div><div class='pill-val "+ZC[zones[0]]+"'>"+fp(vals[0], lang)+"</div></div>"+
            "<div class='pill "+ZC[zones[n-1]]+"'><div class='pill-lbl'>"+txt.last+"</div><div class='pill-val "+ZC[zones[n-1]]+"'>"+fp(vals[n-1], lang)+"</div></div>"+
          "</div>"+
          "<div class='chart-box'><canvas id='ch'></canvas></div>"+
        "</div>"+
        "<div class='right'>"+
          cHTML+
          "<div class='metrics'>"+
            "<div class='mrow'><div class='m'><div class='ml'>"+txt.sal+"</div><div class='mv "+(salHigh?'sh':'so')+"'>"+fm(sal, lang)+"</div></div>"+
            "<div class='m'><div class='ml'>"+txt.avg+"</div><div class='mv'>"+fm(avgsal, lang)+"</div></div></div>"+
            "<div class='mrow'><div class='m'><div class='ml'>"+txt.start+"</div><div class='mv'>"+start+"</div></div>"+
            "<div class='m'><div class='ml'>"+txt.stop+"</div><div class='mv'>"+stop+"</div></div></div>"+
            "<div class='mrow s1'><div class='m'><div class='ml'>"+txt.review+"</div><div class='mv'>"+review+"</div></div></div>"+
            "<div class='mrow'><div class='m'><div class='ml'>"+txt.bench+"</div><span class='badge "+(bY?'y':'n')+"\'>"+(bY?txt.yes:txt.no)+"</span></div>"+
            "<div class='m'><div class='ml'>"+txt.iron+"</div><span class='badge "+(iY?'y':'n')+"'>"+(iY?txt.yes:txt.no)+"</span></div></div>"+
          "</div>"+
        "</div>"+
      "</div>";

    document.getElementById('lsw').onclick = function() {
      currentLang = currentLang === 'ru' ? 'en' : 'ru';
      render(currentLang);
    };

    // ‚îÄ‚îÄ CHART ‚îÄ‚îÄ
    var dlPlugin={
      id:'dl',
      afterDatasetsDraw:function(chart){
        var c=chart.ctx, ca=chart.chartArea; if(!ca)return;
        var barW=(ca.width||300)/Math.max(n,1);
        var sz=Math.max(10,Math.min(14,Math.floor(barW/3)));
        chart.getDatasetMeta(0).data.forEach(function(bar,i){
          c.save();
          c.font='bold '+sz+'px Arial';
          c.fillStyle=BC[zones[i]];
          c.textAlign='center';
          var yOff=vals[i]<0?16:-8;
          c.fillText(fp(vals[i], lang),bar.x,bar.y+yOff);
          c.restore();
        });
      }
    };

    new Chart(document.getElementById('ch').getContext('2d'),{
      type:'bar', 
      plugins:[dlPlugin, {
        id:'zL',
        afterDraw:function(chart){
          var sc=chart.scales.y;if(!sc)return;
          var y0=sc.getPixelForValue(0),c=chart.ctx;
          c.save();c.beginPath();
          c.moveTo(chart.scales.x.left,y0);c.lineTo(chart.scales.x.right,y0);
          c.strokeStyle='rgba(1,61,126,0.2)';c.lineWidth=1.5;c.setLineDash([4,4]);
          c.stroke();c.restore();
        }
      }],
      data:{
        labels:labs,
        datasets:[{
          data:vals.map(function(v){return parseFloat((v*100).toFixed(4));}),
          backgroundColor:zones.map(function(z){return BF[z];}),
          borderWidth:0, borderRadius:4, borderSkipped:false,
          maxBarThickness: 65
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        layout:{padding:{top:25,left:5,right:5,bottom:5}},
        animation: false,
        plugins:{
          legend:{display:false},
          tooltip:{
            backgroundColor:'#013d7e',
            titleFont:{size:13},
            bodyFont:{size:14},
            padding:10,
            callbacks: {
              label: function(ctx) { return ' ' + fp(vals[ctx.dataIndex], lang); }
            }
          }
        },
        scales:{
          x:{
            grid:{display:false},border:{display:false},
            ticks:{font:{size:11,weight:'600'},color:'#8a9ab5',maxRotation:0}
          },
          y:{display:false,grace:'25%'}
        }
      }
    });
  }

  render(currentLang);

})();
</script>
</body>
</html>