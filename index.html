<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { width: 100%; height: 100%; background: #fff; font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
body { display: flex; flex-direction: column; }

.hdr {
  background: linear-gradient(135deg, #013d7e 0%, #1a5fa8 100%);
  padding: 10px 20px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
}
.emp-name { font-size: 22px; font-weight: 900; color: #fff; line-height: 1.1; }
.emp-sub { font-size: 9px; color: rgba(255,255,255,0.7); text-transform: uppercase; font-weight: 700; }

.lang-sw {
  background: #fff; border: none; color: #013d7e; padding: 5px 12px; 
  border-radius: 6px; font-size: 12px; font-weight: 800; cursor: pointer;
}

.info-bar {
  background: #f8fafc; padding: 6px 20px; display: flex; flex-wrap: wrap; gap: 15px; border-bottom: 1px solid #e2e8f0;
}
.info-item { display: flex; flex-direction: column; min-width: 70px; }
.info-label { font-size: 8px; text-transform: uppercase; font-weight: 800; color: #64748b; }
.info-val { font-size: 13px; font-weight: 800; color: #013d7e; }

.main { flex: 1; display: flex; flex-direction: column; min-height: 0; }
.top-section { height: 25vh; padding: 20px 20px 0 20px; flex-shrink: 0; }
.chart-box { height: 100%; width: 100%; position: relative; }

.bottom-section {
  flex: 1; background: #fff; border-top: 1px solid #e2e8f0;
  padding: 10px 20px; overflow-y: auto;
}

.metrics-grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
  gap: 8px; 
}
.m { 
  background: #f8fafc; border-radius: 8px; padding: 10px; 
  border: 1px solid #e2e8f0; display: flex; flex-direction: column;
}
.ml { font-size: 9px; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 2px; }
.mv { font-size: 16px; font-weight: 900; color: #0f172a; }
.msub { font-size: 10px; color: #94a3b8; margin-top: 2px; font-weight: 600; }

.badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; margin-top: 4px; width: fit-content; }
.badge.y { background: #fee2e2; color: #b91c1c; }
.badge.n { background: #f1f5f9; color: #64748b; }

/* –¶–≤–µ—Ç–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã */
.status-green { color: #16a34a !important; }
.status-yellow { color: #f59e0b !important; }
.status-red { color: #dc2626 !important; }

.val-up { color: #16a34a; }
.val-down { color: #dc2626; }

.cmnt { background: #013d7e; border-radius: 8px; padding: 10px; display: flex; gap: 8px; margin-bottom: 10px; color: #fff; align-items: center; }
.cmnt-txt { font-size: 12px; font-weight: 500; }
</style>
</head>
<body>
<div id="root" style="display:contents"></div>

<script>
(function(){
  const q = new URLSearchParams(location.search);
  const langId = (q.get('lang') || 'ru').toLowerCase();
  
  const T = {
    ru: { 
      avgM: '–°—Ä–µ–¥–Ω—è—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å', month: '–º–µ—Å. –Ω–∞–∑–∞–¥', rateL: '–ü–µ—Ä–µ—Å–º–æ—Ç—Ä –†–µ–π—Ç–∞', pr: '–ü–æ—Å–ª–µ–¥–Ω–∏–π PR',
      si: 'Seniority Index', salT: '–ó–ü + –ù–∞–ª–æ–≥–∏', ot: '–û–≤–µ—Ä—Ç–∞–π–º—ã', iron: 'Iron List RM', yes: '–î–∞', no: '–ù–µ—Ç',
      start: '–°—Ç–∞—Ä—Ç –ø–æ–∑–∏—Ü–∏–∏', stop: '–°—Ç–æ–ø –ø–æ–∑–∏—Ü–∏–∏', avgS: '–°—Ä–µ–¥–Ω—è—è –ó–ü', bench: '2nd Bench', 
      tech: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è', lvl: '–£—Ä–æ–≤–µ–Ω—å', reg: '–†–µ–≥–∏–æ–Ω',
      rev: '–í—ã—Ä—É—á–∫–∞', prof: '–ü—Ä–∏–±—ã–ª—å', curRate: '–†–µ–π—Ç'
    },
    en: { 
      avgM: 'Avg Profitability', month: 'mo. ago', rateL: 'Rate Review', pr: 'Last PR',
      si: 'Seniority Index', salT: 'Salary + Tax', ot: 'Overtimes', iron: 'Iron List RM', yes: 'Yes', no: 'No',
      start: 'Position Start', stop: 'Position Stop', avgS: 'Avg Salary', bench: '2nd Bench', 
      tech: 'Technology', lvl: 'Level', reg: 'Region',
      rev: 'Revenue', prof: 'Profit', curRate: 'Rate'
    }
  }[langId];

  const MO = {
    ru: ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'],
    en: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']
  }[langId];

  function fmtLabel(s){
    if(!s) return '';
    const parts = s.split(/[.\-\/]/);
    if(parts.length < 2) return s;
    return MO[parseInt(parts[1]) - 1] + " " + (parts[2] ? parts[2].slice(-2) : '');
  }

  function fmtP(v) { return (v * 100).toFixed(1).replace('.', ',') + '%'; }
  function fmtM(v) { 
    if(!v || v === '0' || v === '‚Äî') return '‚Äî';
    return (langId==='ru' ? '$ ' : '$') + parseInt(v).toLocaleString(langId==='ru'?'ru-RU':'en-US'); 
  }

  function getDiffMonths(dateStr) {
    if (!dateStr || dateStr === '‚Äî') return -1;
    const p = dateStr.split('.');
    if (p.length < 3) return -1;
    const d = new Date(p[2], p[1]-1, p[0]);
    const now = new Date();
    const diff = (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
    return diff > 0 ? diff : 0;
  }

  const siVal = parseFloat(q.get('si')) || 0;
  let siClass = '';
  if (siVal < 2.99) siClass = 'status-green';
  else if (siVal >= 3 && siVal <= 3.24) siClass = 'status-yellow';
  else if (siVal >= 3.25) siClass = 'status-red';

  const rateDiff = getDiffMonths(q.get('ratedate'));
  const rateClass = rateDiff > 12 ? 'status-red' : '';

  const stopDateStr = q.get('stop');
  let stopClass = '';
  if (stopDateStr && stopDateStr !== '‚Äî') {
    const p = stopDateStr.split('.');
    const stopDate = new Date(p[2], p[1]-1, p[0]);
    const now = new Date();
    const diffDays = (stopDate - now) / (1000 * 60 * 60 * 24);
    if (diffDays >= 0 && diffDays <= 30) stopClass = 'status-red';
  }

  const dataRaw = q.get('data') || '';
  let totalRev = 0, totalProf = 0;
  const points = dataRaw.split('|').filter(x => x).map(s => {
    const p = s.split(':');
    const rev = parseFloat(p[1]) || 0;
    const prof = parseFloat(p[2]) || 0;
    totalRev += rev; totalProf += prof;
    return { 
        label: fmtLabel(p[0]), 
        margin: rev !== 0 ? (prof / rev) : 0, 
        zone: parseInt(p[3]) || 2,
        revenue: rev,
        profit: prof
    };
  });

  const avgMargin = totalRev !== 0 ? (totalProf / totalRev) : 0;
  const iy = (v) => v && (v.toLowerCase()==='yes' || v==='1' || v.toLowerCase()==='–¥–∞');

  document.getElementById('root').innerHTML = `
    <div class="hdr">
      <div><div class="emp-name">${q.get('name') || 'John Doe'}</div><div class="emp-sub">Performance Dashboard</div></div>
      <button class="lang-sw" id="swBtn">${langId.toUpperCase()}</button>
    </div>
    <div class="info-bar">
      <div class="info-item"><div class="info-label">${T.tech}</div><div class="info-val">${q.get('tech')||'‚Äî'}</div></div>
      <div class="info-item"><div class="info-label">${T.lvl}</div><div class="info-val">${q.get('lvl')||'‚Äî'}</div></div>
      <div class="info-item"><div class="info-label">${T.reg}</div><div class="info-val">${q.get('reg')||'‚Äî'}</div></div>
    </div>
    <div class="main">
      <div class="top-section"><div class="chart-box"><canvas id="ch"></canvas></div></div>
      <div class="bottom-section">
        ${q.get('comment') ? `<div class="cmnt"><div class="cmnt-txt">üí¨ ${q.get('comment')}</div></div>` : ''}
        <div class="metrics-grid">
          <div class="m"><div class="ml">${T.avgM}</div><div class="mv ${avgMargin >= 0.2 ? 'val-up' : 'val-down'}">${fmtP(avgMargin)}</div></div>
          <div class="m"><div class="ml">${T.si}</div><div class="mv ${siClass}">${siVal.toFixed(1)}</div></div>
          <div class="m"><div class="ml">${T.avgS}</div><div class="mv">${fmtM(q.get('avgsal'))}</div></div>
          <div class="m"><div class="ml">${T.salT}</div><div class="mv">${fmtM(q.get('saltax'))}</div></div>
          <div class="m"><div class="ml">${T.ot}</div><div class="mv">${fmtM(q.get('ot'))}</div></div>
          <div class="m">
            <div class="ml">${T.rateL}</div>
            <div class="mv ${rateClass}">${q.get('ratedate')||'‚Äî'}</div>
            <div class="msub">${rateDiff >= 0 ? rateDiff + ' ' + T.month : ''}</div>
          </div>
          <div class="m">
            <div class="ml">${T.pr}</div>
            <div class="mv">${q.get('prdate')||'‚Äî'}</div>
            <div class="msub">${getDiffMonths(q.get('prdate')) >= 0 ? getDiffMonths(q.get('prdate')) + ' ' + T.month : ''}</div>
          </div>
          <div class="m"><div class="ml">${T.start}</div><div class="mv">${q.get('start')||'‚Äî'}</div></div>
          <div class="m"><div class="ml">${T.stop}</div><div class="mv ${stopClass}">${q.get('stop')||'‚Äî'}</div></div>
          <div class="m"><div class="ml">${T.bench}</div><span class="badge ${iy(q.get('bench'))?'y':'n'}">${iy(q.get('bench'))?T.yes:T.no}</span></div>
          <div class="m"><div class="ml">${T.iron}</div><span class="badge ${iy(q.get('iron'))?'y':'n'}">${iy(q.get('iron'))?T.yes:T.no}</span></div>
        </div>
      </div>
    </div>`;

  document.getElementById('swBtn').onclick = () => {
    const u = new URL(window.location);
    u.searchParams.set('lang', langId === 'ru' ? 'en' : 'ru');
    window.location.href = u.toString();
  };

  const ctx = document.getElementById('ch').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: points.map(p => p.label),
      datasets: [{
        data: points.map(p => p.margin * 100),
        borderColor: '#013d7e',
        borderWidth: 4,
        tension: 0.3,
        pointBackgroundColor: points.map(p => ({1:'#dc2626', 2:'#f59e0b', 3:'#16a34a'}[p.zone])),
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6,
        fill: false
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      layout: { padding: { left: 15, right: 15, top: 25 } },
      plugins: { 
        legend: { display: false },
        tooltip: {
            callbacks: {
                label: (ctx) => {
                    const p = points[ctx.dataIndex];
                    return [
                        `${T.rev}: ${fmtM(p.revenue)}`,
                        `${T.prof}: ${fmtM(p.profit)}`,
                        `${T.curRate}: ${fmtM(q.get('rate'))}`
                    ];
                }
            }
        }
      },
      scales: {
        y: { display: false, grace: '25%' },
        x: { 
          offset: true,
          grid: { display: false },
          ticks: { color: '#013d7e', font: { weight: 'bold', size: 10 } }
        }
      }
    },
    plugins: [{
      id: 'labels',
      afterDatasetsDraw(chart) {
        const {ctx} = chart;
        chart.getDatasetMeta(0).data.forEach((p, i) => {
          ctx.fillStyle = '#013d7e';
          ctx.font = 'bold 11px Arial'; ctx.textAlign = 'center';
          ctx.fillText(fmtP(points[i].margin), p.x, p.y - 12);
        });
      }
    }]
  });
})();
</script>
</body>
</html>