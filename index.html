<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: Segoe UI, Arial, sans-serif;
    background: #f7f9fc;
    padding: 16px;
    height: 100vh;
    overflow: hidden;
  }
  .wrap { display: flex; flex-direction: column; gap: 12px; height: 100%; }

  .hdr { display: flex; justify-content: space-between; align-items: flex-end; }
  .hdr-left h2 {
    color: #013d7e;
    font-size: 17px;
    font-weight: 800;
    text-transform: uppercase;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 480px;
  }
  .hdr-left p { color: #888; font-size: 11px; margin-top: 2px; }

  .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .sbox {
    background: #fff;
    border: 1px solid #e4e8f0;
    border-radius: 8px;
    padding: 8px 12px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .slbl { font-size: 9px; font-weight: 700; text-transform: uppercase; color: #aaa; letter-spacing: .08em; }
  .sval { font-size: 18px; font-weight: 900; }
  .pos { color: #2E7D32; } .neg { color: #C00000; } .warn { color: #C69200; }

  .chart-wrap {
    background: #fff;
    border: 1px solid #e4e8f0;
    border-radius: 10px;
    padding: 14px;
    flex: 1;
    min-height: 0;
    position: relative;
  }
  canvas { width: 100% !important; height: 100% !important; }

  .empty { color: #bbb; font-size: 15px; padding: 30px; text-align: center; margin-top: 60px; }
</style>
</head>
<body>
<div id="app"></div>

<script>
(function () {
  var params = new URLSearchParams(window.location.search);
  var name    = params.get('name');
  var dataRaw = params.get('data');
  var app     = document.getElementById('app');

  if (!name || !dataRaw) {
    app.innerHTML = "<p class='empty'>← Выбери строку в таблице Power BI</p>";
    return;
  }

  // Парсим data: "Янв-24:0.1200|Фев-24:0.2700|..."
  var RAW = dataRaw.split('|').map(function (s) {
    var parts = s.split(':');
    return { p: parts[0], r: parseFloat(parts[1]) || 0 };
  }).filter(function (d) { return d.p; });

  if (!RAW.length) {
    app.innerHTML = "<p class='empty'>Нет данных</p>";
    return;
  }

  var vals  = RAW.map(function (d) { return d.r; });
  var labs  = RAW.map(function (d) { return d.p; });
  var n     = vals.length;
  var avg   = vals.reduce(function (a, b) { return a + b; }, 0) / n;
  var first = vals[0];
  var last  = vals[n - 1];

  function fmtPct(v) { return (v * 100).toFixed(1).replace('.', ',') + '%'; }
  function cls(v)    { return v >= 0.10 ? 'pos' : v > 0 ? 'warn' : 'neg'; }
  function barColor(v) {
    if (v >= 0.10) return 'rgba(46,125,50,0.85)';
    if (v > 0)     return 'rgba(198,146,0,0.85)';
    return 'rgba(192,0,0,0.85)';
  }
  function barBorder(v) {
    if (v >= 0.10) return '#2E7D32';
    if (v > 0)     return '#C69200';
    return '#C00000';
  }

  app.innerHTML =
    "<div class='wrap'>" +
      "<div class='hdr'>" +
        "<div class='hdr-left'>" +
          "<h2>" + name + "</h2>" +
          "<p>Динамика рентабельности • Все периоды</p>" +
        "</div>" +
      "</div>" +
      "<div class='stats'>" +
        "<div class='sbox'><div class='slbl'>Первый период</div><div class='sval " + cls(first) + "'>" + fmtPct(first) + "</div></div>" +
        "<div class='sbox'><div class='slbl'>Последний период</div><div class='sval " + cls(last) + "'>" + fmtPct(last) + "</div></div>" +
        "<div class='sbox'><div class='slbl'>Среднее</div><div class='sval " + cls(avg) + "'>" + fmtPct(avg) + "</div></div>" +
      "</div>" +
      "<div class='chart-wrap'><canvas id='myChart'></canvas></div>" +
    "</div>";

  var ctx = document.getElementById('myChart').getContext('2d');

  // Avg line plugin
  var avgLinePlugin = {
    id: 'avgLine',
    afterDraw: function(chart) {
      var yAxis = chart.scales.y;
      var xAxis = chart.scales.x;
      var avgPx = yAxis.getPixelForValue(avg);
      var ctx2  = chart.ctx;
      ctx2.save();
      ctx2.beginPath();
      ctx2.moveTo(xAxis.left, avgPx);
      ctx2.lineTo(xAxis.right, avgPx);
      ctx2.setLineDash([6, 4]);
      ctx2.strokeStyle = 'rgba(1,61,126,0.5)';
      ctx2.lineWidth   = 1.5;
      ctx2.stroke();
      ctx2.restore();
      // Label
      ctx2.save();
      ctx2.font = 'bold 10px Segoe UI';
      ctx2.fillStyle = '#013d7e';
      ctx2.fillText('avg ' + fmtPct(avg), xAxis.right - 60, avgPx - 5);
      ctx2.restore();
    }
  };

  new Chart(ctx, {
    type: 'bar',
    plugins: [avgLinePlugin],
    data: {
      labels: labs,
      datasets: [{
        label: 'Рентабельность',
        data: vals.map(function(v){ return parseFloat((v * 100).toFixed(2)); }),
        backgroundColor: vals.map(barColor),
        borderColor:     vals.map(barBorder),
        borderWidth: 1.5,
        borderRadius: 4,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 600, easing: 'easeOutQuart' },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ' ' + ctx.parsed.y.toFixed(1).replace('.', ',') + '%';
            }
          },
          backgroundColor: '#013d7e',
          titleFont: { weight: 'bold', size: 12 },
          bodyFont: { size: 13, weight: 'bold' },
          padding: 10,
          cornerRadius: 6
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            font: { size: 10 },
            color: '#999',
            maxRotation: 45
          }
        },
        y: {
          grid: {
            color: 'rgba(0,0,0,0.06)',
            drawTicks: false
          },
          border: { dash: [4, 4] },
          ticks: {
            font: { size: 10 },
            color: '#999',
            callback: function(v) { return v + '%'; }
          }
        }
      }
    }
  });
})();
</script>
</body>
</html>