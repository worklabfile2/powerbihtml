<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body { 
            width: 100%; height: 100%; background: #fff; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            overflow-x: hidden; overflow-y: auto; 
        }
        
        body { display: flex; flex-direction: column; }

        /* –ì–ò–ì–ê–ù–¢–°–ö–ê–Ø –®–ê–ü–ö–ê */
        .hdr {
            background: linear-gradient(135deg, #013d7e 0%, #1a5fa8 100%);
            padding: 30px 40px; flex-shrink: 0; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .emp-name { font-size: 36px; font-weight: 900; color: #fff; line-height: 1; }
        .emp-sub { font-size: 16px; color: rgba(255,255,255,0.8); text-transform: uppercase; font-weight: 700; letter-spacing: 2px; margin-top: 8px; }

        .lang-sw {
            background: #fff; border: none; color: #013d7e; padding: 10px 20px; 
            border-radius: 8px; font-size: 16px; font-weight: 800; cursor: pointer;
        }

        /* –£–í–ï–õ–ò–ß–ï–ù–ù–ê–Ø –ò–ù–§–û-–ü–ê–ù–ï–õ–¨ */
        .info-bar {
            background: #f1f5f9; padding: 20px 40px; display: flex; flex-wrap: wrap; gap: 50px; border-bottom: 2px solid #e2e8f0;
        }
        .info-item { display: flex; flex-direction: column; }
        .info-label { font-size: 13px; text-transform: uppercase; font-weight: 800; color: #64748b; margin-bottom: 6px; }
        .info-val { font-size: 22px; font-weight: 800; color: #013d7e; }

        .main { flex: 1; display: flex; flex-direction: column; }
        
        /* –ì–†–ê–§–ò–ö –ï–©–ï –í–´–®–ï */
        .top-section { height: 380px; padding: 40px 40px 10px 40px; flex-shrink: 0; position: relative; }
        .chart-box { height: 100%; width: 100%; }

        .bottom-section { flex: 1; background: #fff; padding: 30px 40px 60px 40px; }

        /* –û–ì–†–û–ú–ù–´–ï –ö–ê–†–¢–û–ß–ö–ò */
        .metrics-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
            gap: 20px; 
        }
        
        .m { 
            background: #f8fafc; border-radius: 16px; padding: 25px; 
            border: 2px solid #e2e8f0; display: flex; flex-direction: column;
            justify-content: center; min-height: 140px;
        }
        .ml { font-size: 13px; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 12px; }
        .mv { font-size: 32px; font-weight: 900; color: #0f172a; letter-spacing: -1px; }
        .msub { font-size: 14px; color: #94a3b8; margin-top: 8px; font-weight: 700; }

        .badge { display: inline-block; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 800; margin-top: 10px; width: fit-content; }
        .badge.y { background: #fee2e2; color: #b91c1c; }
        .badge.n { background: #f1f5f9; color: #64748b; }

        .status-green { color: #16a34a !important; }
        .status-yellow { color: #f59e0b !important; }
        .status-red { color: #dc2626 !important; }
        .val-up { color: #16a34a; }
        .val-down { color: #dc2626; }

        .cmnt { background: #013d7e; border-radius: 16px; padding: 20px 30px; display: flex; gap: 15px; margin-bottom: 30px; color: #fff; align-items: center; }
        .cmnt-txt { font-size: 18px; font-weight: 500; line-height: 1.5; }
    </style>
</head>
<body>
<div id="root" style="display:contents"></div>

<script>
(function(){
    const q = new URLSearchParams(location.search);
    const langId = (q.get('lang') || 'ru').toLowerCase();
    
    const T = {
        ru: { 
            avgM: '–°—Ä–µ–¥–Ω—è—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å', month: '–º–µ—Å. –Ω–∞–∑–∞–¥', rateL: '–ü–µ—Ä–µ—Å–º–æ—Ç—Ä –†–µ–π—Ç–∞', pr: '–ü–æ—Å–ª–µ–¥–Ω–∏–π PR',
            si: 'Seniority Index', salT: '–ó–ü + –ù–∞–ª–æ–≥–∏', ot: '–û–≤–µ—Ä—Ç–∞–π–º—ã', iron: 'Iron List RM', yes: '–î–∞', no: '–ù–µ—Ç',
            start: '–°—Ç–∞—Ä—Ç –ø–æ–∑–∏—Ü–∏–∏', stop: '–°—Ç–æ–ø –ø–æ–∑–∏—Ü–∏–∏', avgS: '–°—Ä–µ–¥–Ω—è—è –ó–ü', bench: '2nd Bench', 
            tech: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è', lvl: '–£—Ä–æ–≤–µ–Ω—å', reg: '–†–µ–≥–∏–æ–Ω', rev: '–í—ã—Ä—É—á–∫–∞', prof: '–ü—Ä–∏–±—ã–ª—å'
        },
        en: { 
            avgM: 'Avg Profitability', month: 'mo. ago', rateL: 'Rate Review', pr: 'Last PR',
            si: 'Seniority Index', salT: 'Salary + Tax', ot: 'Overtimes', iron: 'Iron List RM', yes: 'Yes', no: 'No',
            start: 'Position Start', stop: 'Position Stop', avgS: 'Avg Salary', bench: '2nd Bench', 
            tech: 'Technology', lvl: 'Level', reg: 'Region', rev: 'Revenue', prof: 'Profit'
        }
    }[langId];

    const MO = {
        ru: ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'],
        en: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']
    }[langId];

    function fmtLabel(s){
        if(!s) return '';
        const parts = s.split(/[.\-\/]/);
        if(parts.length < 2) return s;
        const mIdx = parseInt(parts[1]) - 1;
        return MO[mIdx] + " " + (parts[2] ? parts[2].slice(-2) : '');
    }

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ (—Å –∑–∞–ø—è—Ç–æ–π)
    function fmtP(v) { return (v * 100).toFixed(1).replace('.', ',') + '%'; }
    
    function fmtM(v) { 
        if(!v || v === '0' || v === '‚Äî') return '‚Äî';
        return (langId==='ru' ? '$ ' : '$') + parseInt(v).toLocaleString(langId==='ru'?'ru-RU':'en-US'); 
    }

    function getDiffMonths(dateStr) {
        if (!dateStr || dateStr === '‚Äî') return -1;
        const p = dateStr.split('.');
        if (p.length < 3) return -1;
        const d = new Date(p[2], p[1]-1, p[0]);
        const now = new Date();
        const diff = (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
        return diff > 0 ? diff : 0;
    }

    const siVal = parseFloat(q.get('si')) || 0;
    let siClass = '';
    if (siVal < 2.99) siClass = 'status-green';
    else if (siVal >= 3 && siVal <= 3.24) siClass = 'status-yellow';
    else if (siVal >= 3.25) siClass = 'status-red';

    const rateDiff = getDiffMonths(q.get('ratedate'));
    const rateClass = rateDiff > 12 ? 'status-red' : '';

    const stopDateStr = q.get('stop');
    let stopClass = '';
    if (stopDateStr && stopDateStr !== '‚Äî') {
        const p = stopDateStr.split('.');
        const stopDate = new Date(p[2], p[1]-1, p[0]);
        const now = new Date();
        const diffDays = (stopDate - now) / (1000 * 60 * 60 * 24);
        if (diffDays >= 0 && diffDays <= 30) stopClass = 'status-red';
    }

    const dataRaw = q.get('data') || '';
    let totalRev = 0, totalProf = 0;
    const points = dataRaw.split('|').filter(x => x).map(s => {
        const p = s.split(':');
        const rev = parseFloat(p[1]) || 0;
        const prof = parseFloat(p[2]) || 0;
        totalRev += rev; totalProf += prof;
        return { 
            label: fmtLabel(p[0]), 
            margin: rev !== 0 ? (prof / rev) : 0, 
            zone: parseInt(p[3]) || 2,
            revenue: rev,
            profit: prof
        };
    });

    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    const displayPoints = points.length ? points : [
        {label: '–º–∞–π 25', margin: 0.089, revenue: 10000, profit: 890},
        {label: '–∏—é–Ω 25', margin: 0.067, revenue: 10000, profit: 670},
        {label: '–∏—é–ª 25', margin: 0.076, revenue: 10000, profit: 760},
        {label: '–∞–≤–≥ 25', margin: 0.070, revenue: 10000, profit: 700},
        {label: '—Å–µ–Ω 25', margin: 0.069, revenue: 10000, profit: 690},
        {label: '–æ–∫—Ç 25', margin: 0.076, revenue: 10000, profit: 760},
        {label: '–Ω–æ—è 25', margin: 0.075, revenue: 10000, profit: 750},
        {label: '–¥–µ–∫ 25', margin: 0.067, revenue: 10000, profit: 670},
        {label: '—è–Ω–≤ 26', margin: 0.058, revenue: 10000, profit: 580}
    ];

    const avgMargin = totalRev !== 0 ? (totalProf / totalRev) : 0.072; // –ó–∞–≥–ª—É—à–∫–∞ 7.2% –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
    const iy = (v) => v && (v.toLowerCase()==='yes' || v==='1' || v.toLowerCase()==='–¥–∞');

    document.getElementById('root').innerHTML = `
        <div class="hdr">
            <div><div class="emp-name">${q.get('name') || 'Grigoryan Vahan'}</div><div class="emp-sub">Space (Neobank) ‚Ä¢ Performance Dashboard</div></div>
            <button class="lang-sw" id="swBtn">${langId.toUpperCase()}</button>
        </div>
        <div class="info-bar">
            <div class="info-item"><div class="info-label">${T.tech}</div><div class="info-val">${q.get('tech')||'iOS'}</div></div>
            <div class="info-item"><div class="info-label">${T.lvl}</div><div class="info-val">${q.get('lvl')||'M2'}</div></div>
            <div class="info-item"><div class="info-label">${T.reg}</div><div class="info-val">${q.get('reg')||'CASPI'}</div></div>
        </div>
        <div class="main">
            <div class="top-section"><div class="chart-box"><canvas id="ch"></canvas></div></div>
            <div class="bottom-section">
                ${q.get('comment') ? `<div class="cmnt"><div class="cmnt-txt">üí¨ ${q.get('comment')}</div></div>` : ''}
                <div class="metrics-grid">
                    <div class="m"><div class="ml">${T.avgM}</div><div class="mv ${avgMargin >= 0.2 ? 'val-up' : 'val-down'}">${fmtP(avgMargin)}</div></div>
                    <div class="m"><div class="ml">${T.si}</div><div class="mv ${siClass}">${(siVal || 2.00).toFixed(2)}</div></div>
                    <div class="m"><div class="ml">${T.avgS}</div><div class="mv">${fmtM(q.get('avgsal') || 3000)}</div></div>
                    <div class="m"><div class="ml">${T.salT}</div><div class="mv">${fmtM(q.get('saltax') || 4963)}</div></div>
                    <div class="m"><div class="ml">${T.ot}</div><div class="mv">${fmtM(q.get('ot'))}</div></div>
                    <div class="m">
                        <div class="ml">${T.rateL}</div>
                        <div class="mv ${rateClass}">${q.get('ratedate')||'01.10.2025'}</div>
                        <div class="msub">${rateDiff >= 0 ? rateDiff + ' ' + T.month : '4 –º–µ—Å. –Ω–∞–∑–∞–¥'}</div>
                    </div>
                    <div class="m">
                        <div class="ml">${T.pr}</div>
                        <div class="mv">${q.get('prdate')||'‚Äî'}</div>
                        <div class="msub">${getDiffMonths(q.get('prdate')) >= 0 ? getDiffMonths(q.get('prdate')) + ' ' + T.month : ''}</div>
                    </div>
                    <div class="m"><div class="ml">${T.start}</div><div class="mv">${q.get('start')||'‚Äî'}</div></div>
                    <div class="m"><div class="ml">${T.stop}</div><div class="mv ${stopClass}">${q.get('stop')||'01.12.2026'}</div></div>
                    <div class="m"><div class="ml">${T.bench}</div><span class="badge ${iy(q.get('bench'))?'y':'n'}">${iy(q.get('bench'))?T.yes:T.no}</span></div>
                    <div class="m"><div class="ml">${T.iron}</div><span class="badge ${iy(q.get('iron'))?'y':'n'}">${iy(q.get('iron'))?T.yes:T.no}</span></div>
                </div>
            </div>
        </div>`;

    document.getElementById('swBtn').onclick = () => {
        const u = new URL(window.location);
        u.searchParams.set('lang', langId === 'ru' ? 'en' : 'ru');
        window.location.href = u.toString();
    };

    const ctx = document.getElementById('ch').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: displayPoints.map(p => p.label),
            datasets: [{
                data: displayPoints.map(p => p.margin * 100),
                borderColor: '#013d7e',
                borderWidth: 5,
                tension: 0.4,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#013d7e',
                pointBorderWidth: 4,
                pointRadius: 8,
                pointHoverRadius: 10,
                fill: false
            }]
        },
        options: {
            responsive: true, 
            maintainAspectRatio: false,
            layout: { padding: { left: 20, right: 20, top: 50, bottom: 20 } },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(1, 61, 126, 0.95)',
                    padding: 15,
                    titleFont: { size: 16, weight: 'bold' },
                    bodyFont: { size: 14, weight: '600' },
                    cornerRadius: 10,
                    callbacks: {
                        label: (ctx) => {
                            const p = displayPoints[ctx.dataIndex];
                            return [
                                `${T.rev}: ${fmtM(p.revenue)}`,
                                `${T.prof}: ${fmtM(p.profit)}`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: { display: false, grace: '30%' },
                x: { 
                    grid: { display: false },
                    ticks: { color: '#64748b', font: { weight: '800', size: 14 } }
                }
            }
        },
        plugins: [{
            id: 'labels',
            afterDatasetsDraw(chart) {
                const {ctx} = chart;
                chart.getDatasetMeta(0).data.forEach((p, i) => {
                    const val = displayPoints[i].margin;
                    ctx.fillStyle = '#013d7e';
                    ctx.font = 'bold 16px Segoe UI'; 
                    ctx.textAlign = 'center';
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é fmtP
                    ctx.fillText(fmtP(val), p.x, p.y - 25);
                });
            }
        }]
    });
})();
</script>
</body>
</html>