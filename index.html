<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #013d7e;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --mute: #64748b;
            --red: #ef4444;
            --yellow: #f59e0b;
            --green: #10b981;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; background: var(--bg); font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
        body { display: flex; flex-direction: column; }

        /* ШАПКА */
        .hdr {
            background: var(--primary); padding: 16px 25px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center; color: white;
        }
        .emp-name { font-size: 22px; font-weight: 900; }
        .emp-sub { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }

        /* СЕТКА DASHBOARD (L-LAYOUT) */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 300px; /* График слева, 4 карточки справа */
            grid-template-rows: 1fr auto;    /* График сверху, блоки снизу */
            gap: 20px;
            padding: 20px;
            flex: 1;
            min-height: 0;
        }

        /* ЛЕВО ВЕРХ: ГРАФИК */
        .chart-section {
            background: var(--card); border-radius: 12px; border: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column; min-width: 0;
        }

        /* ПРАВО ВЕРХ: 4 КАРТОЧКИ */
        .top-right-kpi {
            display: flex; flex-direction: column; gap: 12px;
        }

        /* НИЖНИЕ БЛОКИ */
        .bottom-section {
            grid-column: 1 / -1; /* Растягиваем на всю ширину */
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }

        .block-card {
            background: var(--card); border-radius: 12px; border: 1px solid var(--border);
            padding: 15px 20px; min-height: 140px;
        }

        .block-title {
            font-size: 11px; font-weight: 800; color: var(--mute);
            text-transform: uppercase; margin-bottom: 12px;
            border-bottom: 1px solid var(--border); padding-bottom: 6px;
            display: flex; justify-content: space-between;
        }

        /* ЭЛЕМЕНТЫ МЕТРИК */
        .m-item { display: flex; flex-direction: column; }
        .m-label { font-size: 10px; font-weight: 800; color: var(--mute); text-transform: uppercase; margin-bottom: 4px; }
        .m-val { font-size: 19px; font-weight: 900; color: #0f172a; }
        .m-sub { font-size: 10px; color: #94a3b8; font-weight: 600; margin-top: 2px; }

        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }

        /* КАРТОЧКА KPI (ПРАВАЯ ПАНЕЛЬ) */
        .side-card {
            background: var(--card); padding: 14px; border-radius: 10px;
            border: 1px solid var(--border); transition: 0.2s;
        }
        .side-card:hover { border-color: #cbd5e1; transform: translateY(-2px); }

        /* ИНДИКАТОРЫ */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; margin-top: 5px; }
        .bg-red { background: #fee2e2; color: var(--red); }
        .bg-green { background: #dcfce7; color: var(--green); }
        .status-red { color: var(--red) !important; }
        .status-yellow { color: var(--yellow) !important; }
        .status-green { color: var(--green) !important; }

        canvas { width: 100% !important; height: 100% !important; }
    </style>
</head>
<body>

<header class="hdr">
    <div>
        <div class="emp-name" id="userName">Loading...</div>
        <div class="emp-sub" id="userSub">Project Performance Dashboard</div>
    </div>
    <div style="opacity: 0.4; font-weight: 900; font-size: 12px;">WTW 2026</div>
</header>

<main class="dashboard">
    <div class="chart-section">
        <div class="block-title">Profitability Trend</div>
        <div style="flex:1; min-height: 0;"><canvas id="ch"></canvas></div>
    </div>

    <div class="top-right-kpi">
        <div class="side-card">
            <div class="m-label" id="L_avgM">Avg Profitability</div>
            <div class="m-val" id="avgProfValue">0.0%</div>
        </div>
        <div class="side-card">
            <div class="m-label" id="L_salT">Salary + Tax</div>
            <div class="m-val" id="salTaxValue">—</div>
            <div class="m-sub" id="salAvgSub"></div>
        </div>
        <div class="side-card">
            <div class="m-label" id="L_iron">Iron List</div>
            <div id="ironBadge"></div>
        </div>
        <div class="side-card">
            <div class="m-label" id="L_bench">2nd Bench</div>
            <div id="benchBadge"></div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="block-card">
            <div class="block-title" id="L_empTitle">Сотрудник</div>
            <div class="metrics-grid">
                <div class="m-item">
                    <div class="m-label" id="L_rate">Rate Review</div>
                    <div class="m-val" id="rateDate">01.10.2025</div>
                    <div class="m-sub" id="rateSub"></div>
                </div>
                <div class="m-item">
                    <div class="m-label" id="L_pr">Last PR</div>
                    <div class="m-val" id="prDate">—</div>
                </div>
                <div class="m-item">
                    <div class="m-label" id="L_start">Start Date</div>
                    <div class="m-val" id="startDate">—</div>
                </div>
                <div class="m-item">
                    <div class="m-label" id="L_stop">Stop Date</div>
                    <div class="m-val" id="stopDate">—</div>
                </div>
            </div>
        </div>

        <div class="block-card">
            <div class="block-title" id="L_projTitle">Проект</div>
            <div class="metrics-grid">
                <div class="m-item">
                    <div class="m-label">Seniority Index</div>
                    <div class="m-val" id="siValue">0.00</div>
                    <div class="m-sub" id="siZoneSub">Zone -</div>
                </div>
                <div class="m-item">
                    <div class="m-label">Project FTE</div>
                    <div class="m-val" id="fteValue">1.0</div>
                </div>
                <div class="m-item">
                    <div class="m-label">Project Margin</div>
                    <div class="m-val status-green">12.4%</div>
                </div>
                <div class="m-item">
                    <div class="m-label" id="L_ot">Overtimes</div>
                    <div class="m-val" id="otValue">—</div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
(function(){
    const q = new URLSearchParams(location.search);
    const lang = (q.get('lang') || 'ru').toLowerCase();
    
    // Переводы
    const T = {
        ru: { avgM: 'Сред. Рентабельность', salT: 'ЗП + Налоги', iron: 'Iron List', bench: '2nd Bench', rate: 'Рейт ревью', pr: 'Последний PR', ot: 'Овертаймы', start: 'Старт', stop: 'Стоп', emp: 'Сотрудник', proj: 'Проект', mo: 'мес. назад' },
        en: { avgM: 'Avg Profitability', salT: 'Salary + Tax', iron: 'Iron List', bench: '2nd Bench', rate: 'Rate Review', pr: 'Last PR', ot: 'Overtimes', start: 'Start', stop: 'Stop', emp: 'Employee', proj: 'Project', mo: 'mo. ago' }
    }[lang];

    // Применяем переводы
    document.getElementById('L_avgM').innerText = T.avgM;
    document.getElementById('L_salT').innerText = T.salT;
    document.getElementById('L_iron').innerText = T.iron;
    document.getElementById('L_bench').innerText = T.bench;
    document.getElementById('L_rate').innerText = T.rate;
    document.getElementById('L_pr').innerText = T.pr;
    document.getElementById('L_ot').innerText = T.ot;
    document.getElementById('L_start').innerText = T.start;
    document.getElementById('L_stop').innerText = T.stop;
    document.getElementById('L_empTitle').innerText = T.emp;
    document.getElementById('L_projTitle').innerText = T.proj;

    // Вспомогательные функции
    const fmtM = (v) => v ? '$' + parseInt(v).toLocaleString() : '—';
    const iy = (v) => v && (v==='1' || v.toLowerCase()==='yes' || v.toLowerCase()==='да');

    // Наполнение данными
    document.getElementById('userName').innerText = q.get('name') || 'Mayilvahan Vijay';
    document.getElementById('userSub').innerText = (q.get('tech') || 'Data Engineer') + ' • ' + (q.get('lvl') || 'M1');
    
    // SI Logic
    const si = parseFloat(q.get('si')) || 2.45;
    const siEl = document.getElementById('siValue');
    siEl.innerText = si.toFixed(2);
    let zone = 1;
    if (si < 2.99) { siEl.classList.add('status-green'); zone = 3; }
    else if (si < 3.25) { siEl.classList.add('status-yellow'); zone = 2; }
    else { siEl.classList.add('status-red'); zone = 1; }
    document.getElementById('siZoneSub').innerText = 'Zone ' + zone;

    // Карточки KPI
    const saltax = parseFloat(q.get('saltax')) || 14166;
    const avgsal = parseFloat(q.get('avgsal')) || 12000;
    document.getElementById('salTaxValue').innerText = fmtM(saltax);
    document.getElementById('salAvgSub').innerText = 'Avg: ' + fmtM(avgsal);
    if(saltax > avgsal) document.getElementById('salTaxValue').classList.add('status-red');

    document.getElementById('ironBadge').innerHTML = `<span class="badge ${iy(q.get('iron'))?'bg-green':'bg-red'}">${iy(q.get('iron'))?'YES':'NO'}</span>`;
    document.getElementById('benchBadge').innerHTML = `<span class="badge ${iy(q.get('bench'))?'bg-green':'bg-red'}">${iy(q.get('bench'))?'YES':'NO'}</span>`;
    
    // Даты
    document.getElementById('rateDate').innerText = q.get('ratedate') || '01.10.2025';
    document.getElementById('prDate').innerText = q.get('prdate') || '15.01.2026';
    document.getElementById('startDate').innerText = q.get('start') || '01.01.2024';
    const stopD = q.get('stop') || '01.12.2026';
    document.getElementById('stopDate').innerText = stopD;
    document.getElementById('stopDate').classList.add('status-red');

    document.getElementById('otValue').innerText = fmtM(q.get('ot') || 240);
    document.getElementById('fteValue').innerText = q.get('fte') || '1.0';

    // ГРАФИК
    const dataRaw = q.get('data') || "01.25:10000:720:2|02.25:11000:800:2|03.25:10500:400:1";
    let tRev = 0, tProf = 0;
    const points = dataRaw.split('|').map(s => {
        const p = s.split(':');
        const rev = parseFloat(p[1]) || 0;
        const prof = parseFloat(p[2]) || 0;
        tRev += rev; tProf += prof;
        return { label: p[0], margin: rev?((prof/rev)*100):0, zone: parseInt(p[3])||2 };
    });

    const avgM = tRev ? (tProf/tRev)*100 : 7.2;
    const avgPValue = document.getElementById('avgProfValue');
    avgPValue.innerText = avgM.toFixed(1) + '%';
    if(avgM < 5) avgPValue.classList.add('status-red');

    const ctx = document.getElementById('ch').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: points.map(p => p.label),
            datasets: [{
                data: points.map(p => p.margin),
                borderColor: '#013d7e',
                borderWidth: 3,
                tension: 0.4,
                pointBackgroundColor: points.map(p => p.zone===3?'#10b981':p.zone===2?'#f59e0b':'#ef4444'),
                pointRadius: 6,
                fill: true,
                backgroundColor: 'rgba(1, 61, 126, 0.03)'
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { display: false }, x: { grid: { display: false } } }
        }
    });
})();
</script>
</body>
</html>