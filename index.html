<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body { 
            width: 100%; height: 100%; background: #fff; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            overflow: hidden; 
        }
        
        body { display: flex; flex-direction: column; }

        /* –®–ê–ü–ö–ê –° –ò–ù–î–ò–ö–ê–¢–û–†–û–ú –°–¢–ê–¢–£–°–ê */
        .hdr {
            background: linear-gradient(135deg, #013d7e 0%, #1a5fa8 100%);
            padding: 22px 30px; flex-shrink: 0; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .hdr-left { display: flex; align-items: center; gap: 18px; }
        
        /* –ò–ù–î–ò–ö–ê–¢–û–† –°–¢–ê–¢–£–°–ê –ü–û–ó–ò–¶–ò–ò */
        .status-indicator {
            width: 18px; height: 18px; border-radius: 50%; 
            flex-shrink: 0;
        }
        .status-indicator.green { 
            background: #10b981; 
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.8), 0 0 40px rgba(16, 185, 129, 0.4);
        }
        .status-indicator.yellow { 
            background: #f59e0b; 
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.8), 0 0 40px rgba(245, 158, 11, 0.4);
        }
        .status-indicator.red { 
            background: #ef4444; 
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.8), 0 0 40px rgba(239, 68, 68, 0.4);
        }
        
        .emp-name { font-size: 26px; font-weight: 900; color: #fff; line-height: 1.1; }
        .emp-sub { 
            font-size: 12px; color: rgba(255,255,255,0.85); 
            text-transform: uppercase; font-weight: 700; 
            letter-spacing: 1.5px; margin-top: 5px; 
        }

        .lang-sw {
            background: #fff; border: none; color: #013d7e; 
            padding: 8px 16px; border-radius: 6px; 
            font-size: 13px; font-weight: 800; cursor: pointer;
            transition: all 0.2s;
        }
        .lang-sw:hover { transform: scale(1.05); }

        /* –ò–ù–§–û-–ü–ê–ù–ï–õ–¨ */
        .info-bar {
            background: #f8fafc; padding: 14px 30px; 
            display: flex; flex-wrap: wrap; gap: 35px; 
            border-bottom: 2px solid #e2e8f0; flex-shrink: 0;
        }
        .info-item { display: flex; flex-direction: column; }
        .info-label { 
            font-size: 10px; text-transform: uppercase; 
            font-weight: 800; color: #64748b; margin-bottom: 4px; 
        }
        .info-val { font-size: 17px; font-weight: 800; color: #013d7e; }

        .main { flex: 1; display: flex; overflow: hidden; }
        
        /* –õ–ï–í–ê–Ø –ß–ê–°–¢–¨ - –ì–†–ê–§–ò–ö */
        .left-section { 
            flex: 1; 
            padding: 20px 25px; 
            display: flex; 
            flex-direction: column;
            min-width: 0;
            background: #fff;
        }
        .chart-box { flex: 1; width: 100%; min-height: 0; }

        /* –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨ - –ö–ê–†–¢–û–ß–ö–ò */
        .right-section { 
            width: 420px; 
            background: #f8fafc; 
            padding: 20px 18px 20px 18px; 
            overflow-y: auto;
            border-left: 2px solid #e2e8f0;
            flex-shrink: 0;
        }
        .right-section::-webkit-scrollbar { width: 6px; }
        .right-section::-webkit-scrollbar-track { background: #f1f5f9; }
        .right-section::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô */
        .cmnt { 
            background: linear-gradient(135deg, #013d7e 0%, #1a5fa8 100%);
            border-radius: 10px; 
            padding: 14px 18px; 
            color: #fff; 
            margin-bottom: 18px; 
            font-size: 13px; 
            line-height: 1.5; 
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(1, 61, 126, 0.2);
        }

        /* –ö–ê–†–¢–û–ß–ö–ò */
        .metrics-grid { 
            display: flex;
            flex-direction: column;
            gap: 12px; 
        }
        
        .m { 
            background: #fff; 
            border-radius: 10px; 
            padding: 16px; 
            border: 2px solid #e2e8f0; 
            display: flex; 
            flex-direction: column;
            transition: all 0.2s;
        }
        .m:hover { 
            border-color: #cbd5e1; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .ml { 
            font-size: 10px; font-weight: 800; 
            text-transform: uppercase; color: #64748b; 
            margin-bottom: 7px; letter-spacing: 0.5px;
        }
        .mv { 
            font-size: 24px; font-weight: 900; 
            color: #0f172a; letter-spacing: -0.5px; 
        }
        .msub { 
            font-size: 11px; color: #94a3b8; 
            margin-top: 5px; font-weight: 600; 
        }

        .badge { 
            display: inline-block; 
            padding: 6px 12px; 
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: 800; 
            margin-top: 7px; 
            width: fit-content; 
        }
        .badge.y { background: #fee2e2; color: #dc2626; }
        .badge.n { background: #e2e8f0; color: #64748b; }

        /* –û–ß–ï–ù–¨ –Ø–†–ö–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–´ */
        .status-green { color: #10b981 !important; font-weight: 900 !important; }
        .status-yellow { color: #f59e0b !important; font-weight: 900 !important; }
        .status-red { color: #ef4444 !important; font-weight: 900 !important; }
        .val-up { color: #10b981; font-weight: 900; }
        .val-down { color: #ef4444; font-weight: 900; }

        /* –°–ö–†–´–¢–´–ô SI */
        .hidden-metric {
            font-size: 7px;
            color: #e2e8f0;
            margin-top: 15px;
            text-align: center;
            opacity: 0.4;
        }
    </style>
</head>
<body>
<div id="root" style="display:contents"></div>

<script>
(function(){
    const q = new URLSearchParams(location.search);
    const langId = (q.get('lang') || 'ru').toLowerCase();
    
    const T = {
        ru: { 
            avgM: '–°—Ä–µ–¥–Ω—è—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å', month: '–º–µ—Å. –Ω–∞–∑–∞–¥', rateL: '–ü–µ—Ä–µ—Å–º–æ—Ç—Ä –†–µ–π—Ç–∞', pr: '–ü–æ—Å–ª–µ–¥–Ω–∏–π PR',
            si: 'Seniority Index', salT: '–ó–ü + –ù–∞–ª–æ–≥–∏', ot: '–û–≤–µ—Ä—Ç–∞–π–º—ã', iron: 'Iron List', ironRM: 'Iron List RM',
            yes: '–î–∞', no: '–ù–µ—Ç', start: '–°—Ç–∞—Ä—Ç –ø–æ–∑–∏—Ü–∏–∏', stop: '–°—Ç–æ–ø –ø–æ–∑–∏—Ü–∏–∏', 
            bench: '2nd Bench', tech: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è', lvl: '–£—Ä–æ–≤–µ–Ω—å', reg: '–†–µ–≥–∏–æ–Ω', 
            rev: '–í—ã—Ä—É—á–∫–∞', prof: '–ü—Ä–∏–±—ã–ª—å', ironDate: '–î–∞—Ç–∞'
        },
        en: { 
            avgM: 'Avg Profitability', month: 'mo. ago', rateL: 'Rate Review', pr: 'Last PR',
            si: 'Seniority Index', salT: 'Salary + Tax', ot: 'Overtimes', iron: 'Iron List', ironRM: 'Iron List RM',
            yes: 'Yes', no: 'No', start: 'Position Start', stop: 'Position Stop', 
            bench: '2nd Bench', tech: 'Technology', lvl: 'Level', reg: 'Region', 
            rev: 'Revenue', prof: 'Profit', ironDate: 'Date'
        }
    }[langId];

    const MO = {
        ru: ['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'],
        en: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']
    }[langId];

    function fmtLabel(s){
        if(!s) return '';
        const parts = s.split(/[.\-\/]/);
        if(parts.length < 2) return s;
        const mIdx = parseInt(parts[1]) - 1;
        return MO[mIdx] + " " + (parts[2] ? parts[2].slice(-2) : '');
    }

    function fmtP(v) { return (v * 100).toFixed(1).replace('.', ',') + '%'; }
    
    function fmtM(v) { 
        if(!v || v === '0' || v === '‚Äî') return '‚Äî';
        return (langId==='ru' ? '$ ' : '$') + parseInt(v).toLocaleString(langId==='ru'?'ru-RU':'en-US'); 
    }

    function getDiffMonths(dateStr) {
        if (!dateStr || dateStr === '‚Äî') return -1;
        const p = dateStr.split('.');
        if (p.length < 3) return -1;
        const d = new Date(p[2], p[1]-1, p[0]);
        const now = new Date();
        const diff = (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
        return diff > 0 ? diff : 0;
    }

    // SI
    const siVal = parseFloat(q.get('si')) || 2.00;
    let siClass = '';
    if (siVal < 2.99) siClass = 'status-green';
    else if (siVal >= 3 && siVal <= 3.24) siClass = 'status-yellow';
    else if (siVal >= 3.25) siClass = 'status-red';

    // Rate Review
    const rateDiff = getDiffMonths(q.get('ratedate'));
    const rateClass = rateDiff > 12 ? 'status-red' : '';

    // Stop Date
    const stopDateStr = q.get('stop');
    let stopClass = '';
    if (stopDateStr && stopDateStr !== '‚Äî') {
        const p = stopDateStr.split('.');
        if (p.length >= 3) {
            const stopDate = new Date(p[2], p[1]-1, p[0]);
            const now = new Date();
            const diffDays = (stopDate - now) / (1000 * 60 * 60 * 24);
            if (diffDays >= 0 && diffDays <= 30) stopClass = 'status-red';
        }
    }

    // –ì—Ä–∞—Ñ–∏–∫
    const dataRaw = q.get('data') || '';
    let totalRev = 0, totalProf = 0;
    const points = dataRaw.split('|').filter(x => x).map(s => {
        const p = s.split(':');
        const rev = parseFloat(p[1]) || 0;
        const prof = parseFloat(p[2]) || 0;
        totalRev += rev; totalProf += prof;
        return { 
            label: fmtLabel(p[0]), 
            margin: rev !== 0 ? (prof / rev) : 0, 
            zone: parseInt(p[3]) || 2,
            revenue: rev,
            profit: prof
        };
    });

    const displayPoints = points.length ? points : [
        {label: '–º–∞–π 25', margin: 0.089, revenue: 10000, profit: 890, zone: 2},
        {label: '–∏—é–Ω 25', margin: 0.067, revenue: 10000, profit: 670, zone: 2},
        {label: '–∏—é–ª 25', margin: 0.076, revenue: 10000, profit: 760, zone: 2},
        {label: '–∞–≤–≥ 25', margin: 0.070, revenue: 10000, profit: 700, zone: 2},
        {label: '—Å–µ–Ω 25', margin: 0.069, revenue: 10000, profit: 690, zone: 2},
        {label: '–æ–∫—Ç 25', margin: 0.076, revenue: 10000, profit: 760, zone: 1},
        {label: '–Ω–æ—è 25', margin: 0.075, revenue: 10000, profit: 750, zone: 1},
        {label: '–¥–µ–∫ 25', margin: 0.067, revenue: 10000, profit: 670, zone: 1},
        {label: '—è–Ω–≤ 26', margin: 0.058, revenue: 10000, profit: 580, zone: 1}
    ];

    const avgMargin = totalRev !== 0 ? (totalProf / totalRev) : 0.072;
    
    // –ò–ù–î–ò–ö–ê–¢–û–† –ü–û–ó–ò–¶–ò–ò (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ä–µ–¥–Ω–µ–π —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏)
    let statusClass = 'green';
    if (avgMargin < 0.05) statusClass = 'red';
    else if (avgMargin >= 0.05 && avgMargin < 0.1) statusClass = 'yellow';
    else statusClass = 'green';
    
    // –ó–ü + –ù–ê–õ–û–ì–ò –° –¶–í–ï–¢–û–ú (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ —Å—Ä–µ–¥–Ω–µ–π)
    const avgSalary = parseFloat(q.get('avgsal')) || 3000;
    const salaryTax = parseFloat(q.get('saltax')) || 4963;
    let salaryClass = '';
    if (salaryTax > avgSalary) salaryClass = 'status-red';
    else if (salaryTax < avgSalary) salaryClass = 'status-green';
    
    const iy = (v) => v && (v.toLowerCase()==='yes' || v==='1' || v.toLowerCase()==='–¥–∞');

    document.getElementById('root').innerHTML = `
        <div class="hdr">
            <div class="hdr-left">
                <div class="status-indicator ${statusClass}"></div>
                <div>
                    <div class="emp-name">${q.get('name') || 'Grigoryan Vahan'}</div>
                    <div class="emp-sub">Space (Neobank) ‚Ä¢ Performance Dashboard</div>
                </div>
            </div>
            <button class="lang-sw" id="swBtn">${langId.toUpperCase()}</button>
        </div>
        <div class="info-bar">
            <div class="info-item"><div class="info-label">${T.tech}</div><div class="info-val">${q.get('tech')||'iOS'}</div></div>
            <div class="info-item"><div class="info-label">${T.lvl}</div><div class="info-val">${q.get('lvl')||'M2'}</div></div>
            <div class="info-item"><div class="info-label">${T.reg}</div><div class="info-val">${q.get('reg')||'CASPI'}</div></div>
        </div>
        <div class="main">
            <div class="left-section">
                <div class="chart-box"><canvas id="ch"></canvas></div>
            </div>
            <div class="right-section">
                ${q.get('comment') ? `<div class="cmnt">üí¨ ${q.get('comment')}</div>` : ''}
                <div class="metrics-grid">
                    <div class="m">
                        <div class="ml">${T.avgM}</div>
                        <div class="mv ${avgMargin >= 0.2 ? 'val-up' : avgMargin < 0.05 ? 'val-down' : ''}">${fmtP(avgMargin)}</div>
                    </div>
                    <div class="m">
                        <div class="ml">${T.salT}</div>
                        <div class="mv ${salaryClass}">${fmtM(salaryTax)}</div>
                        ${avgSalary ? `<div class="msub">–°—Ä–µ–¥–Ω—è—è: ${fmtM(avgSalary)}</div>` : ''}
                    </div>
                    <div class="m">
                        <div class="ml">${T.ot}</div>
                        <div class="mv">${fmtM(q.get('ot'))}</div>
                    </div>
                    <div class="m">
                        <div class="ml">${T.rateL}</div>
                        <div class="mv ${rateClass}">${q.get('ratedate')||'01.10.2025'}</div>
                        <div class="msub">${rateDiff >= 0 ? rateDiff + ' ' + T.month : '4 –º–µ—Å. –Ω–∞–∑–∞–¥'}</div>
                    </div>
                    <div class="m">
                        <div class="ml">${T.pr}</div>
                        <div class="mv">${q.get('prdate')||'‚Äî'}</div>
                        ${getDiffMonths(q.get('prdate')) >= 0 ? `<div class="msub">${getDiffMonths(q.get('prdate'))} ${T.month}</div>` : ''}
                    </div>
                    <div class="m">
                        <div class="ml">${T.start}</div>
                        <div class="mv">${q.get('start')||'‚Äî'}</div>
                    </div>
                    <div class="m">
                        <div class="ml">${T.stop}</div>
                        <div class="mv ${stopClass}">${q.get('stop')||'01.12.2026'}</div>
                    </div>
                    <div class="m">
                        <div class="ml">${T.bench}</div>
                        <span class="badge ${iy(q.get('bench'))?'y':'n'}">${iy(q.get('bench'))?T.yes:T.no}</span>
                    </div>
                    <div class="m">
                        <div class="ml">${T.iron}</div>
                        <span class="badge ${iy(q.get('iron'))?'y':'n'}">${iy(q.get('iron'))?T.yes:T.no}</span>
                        <div class="msub">${T.ironDate}: ${q.get('irondate')||'‚Äî'}</div>
                    </div>
                    <div class="m">
                        <div class="ml">${T.ironRM}</div>
                        <span class="badge ${iy(q.get('ironrm'))?'y':'n'}">${iy(q.get('ironrm'))?T.yes:T.no}</span>
                    </div>
                </div>
                <div class="hidden-metric">SI: ${siVal.toFixed(2)}</div>
            </div>
        </div>`;

    document.getElementById('swBtn').onclick = () => {
        const u = new URL(window.location);
        u.searchParams.set('lang', langId === 'ru' ? 'en' : 'ru');
        window.location.href = u.toString();
    };

    // –¶–í–ï–¢–ê –¢–û–ß–ï–ö –ü–û –ó–û–ù–ê–ú
    function getZoneColor(zone) {
        if (zone === 1) return '#10b981'; // –ó–µ–ª–µ–Ω–∞—è –∑–æ–Ω–∞
        if (zone === 2) return '#f59e0b'; // –ñ–µ–ª—Ç–∞—è –∑–æ–Ω–∞
        if (zone === 3) return '#ef4444'; // –ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞
        return '#64748b'; // –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }

    const ctx = document.getElementById('ch').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: displayPoints.map(p => p.label),
            datasets: [{
                data: displayPoints.map(p => p.margin * 100),
                borderColor: '#013d7e',
                borderWidth: 4,
                tension: 0.4,
                pointBackgroundColor: displayPoints.map(p => getZoneColor(p.zone)),
                pointBorderColor: '#fff',
                pointBorderWidth: 3,
                pointRadius: 8,
                pointHoverRadius: 10,
                fill: false
            }]
        },
        options: {
            responsive: true, 
            maintainAspectRatio: false,
            layout: { padding: { left: 15, right: 15, top: 35, bottom: 15 } },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(1, 61, 126, 0.95)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13, weight: '600' },
                    cornerRadius: 8,
                    callbacks: {
                        label: (ctx) => {
                            const p = displayPoints[ctx.dataIndex];
                            return [
                                `${T.rev}: ${fmtM(p.revenue)}`,
                                `${T.prof}: ${fmtM(p.profit)}`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: { display: false, grace: '30%' },
                x: { 
                    grid: { display: false },
                    ticks: { color: '#64748b', font: { weight: '700', size: 12 } }
                }
            }
        },
        plugins: [{
            id: 'labels',
            afterDatasetsDraw(chart) {
                const {ctx} = chart;
                chart.getDatasetMeta(0).data.forEach((p, i) => {
                    const val = displayPoints[i].margin;
                    ctx.fillStyle = '#013d7e';
                    ctx.font = 'bold 13px Segoe UI'; 
                    ctx.textAlign = 'center';
                    ctx.fillText(fmtP(val), p.x, p.y - 18);
                });
            }
        }]
    });
})();
</script>
</body>
</html>