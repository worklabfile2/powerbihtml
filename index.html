<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  width: 100%; height: 100%;
  background: #ffffff;
  font-family: Arial, sans-serif;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
body { display: flex; flex-direction: column; }

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.card-header {
  background: linear-gradient(135deg, #013d7e 0%, #1a5fa8 60%, #2272c3 100%);
  padding: 14px 20px 12px;
  flex-shrink: 0;
  position: relative;
  overflow: hidden;
}
.card-header::before {
  content: '';
  position: absolute; top: -50px; right: -30px;
  width: 160px; height: 160px;
  background: rgba(255,255,255,0.06); border-radius: 50%;
}
.card-header::after {
  content: '';
  position: absolute; bottom: -50px; right: 100px;
  width: 110px; height: 110px;
  background: rgba(255,255,255,0.04); border-radius: 50%;
}
.emp-name {
  font-size: clamp(16px, 2.4vw, 24px);
  font-weight: 900; color: #fff;
  letter-spacing: -0.01em; line-height: 1.15;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  position: relative; z-index: 1;
}
.emp-sub {
  font-size: clamp(9px, 1.1vw, 11px);
  color: rgba(255,255,255,0.55);
  letter-spacing: 0.16em; text-transform: uppercase;
  margin-top: 3px; font-weight: 700;
  position: relative; z-index: 1;
}

/* ‚ïê‚ïê‚ïê BODY ‚ïê‚ïê‚ïê */
.card-body {
  flex: 1; min-height: 0;
  display: grid;
  grid-template-columns: 1fr 260px;
}

/* ‚ïê‚ïê‚ïê LEFT: CHART ‚ïê‚ïê‚ïê */
.chart-section {
  padding: 14px 14px 12px 16px;
  display: flex; flex-direction: column; gap: 10px;
  border-right: 1px solid #edf2f9;
}

.rent-pills { display: flex; gap: 8px; flex-shrink: 0; }

.pill {
  flex: 1; background: #f5f8fd;
  border-radius: 12px; padding: 10px 14px;
  text-align: center; cursor: pointer;
  transition: box-shadow 0.2s, background 0.2s;
  animation: fadeUp 0.35s ease both;
  position: relative; overflow: hidden;
  border: 1.5px solid transparent;
}
.pill:hover {
  box-shadow: 0 6px 20px rgba(1,61,126,0.13);
  background: #fff;
  border-color: #dde8f8;
}
.pill::after {
  content: ''; position: absolute;
  bottom: 0; left: 0; right: 0; height: 3px;
  border-radius: 0 0 12px 12px;
}
.pill.z1::after { background: #c0392b; }
.pill.z2::after { background: #9a6e00; }
.pill.z3::after { background: #1a6b3a; }

.pill-lbl {
  font-size: clamp(8px, 1vw, 10px); font-weight: 800;
  text-transform: uppercase; letter-spacing: .12em;
  color: #8a9ab5; margin-bottom: 4px;
}
.pill-val {
  font-size: clamp(22px, 3.4vw, 34px);
  font-weight: 900; line-height: 1;
}
.pill-val.z1 { color: #c0392b; }
.pill-val.z2 { color: #9a6e00; }
.pill-val.z3 { color: #1a6b3a; }

.chart-box {
  flex: 1; min-height: 0;
  position: relative;
  animation: fadeUp 0.4s 0.1s ease both;
}
.chart-box canvas {
  position: absolute; inset: 0;
  width: 100% !important; height: 100% !important;
}

/* ‚ïê‚ïê‚ïê RIGHT: INFO ‚ïê‚ïê‚ïê */
.info-section {
  padding: 12px 16px 12px 14px;
  display: flex; flex-direction: column; gap: 8px;
  background: #fafbfd;
  overflow: hidden;
}

/* Comment */
.comment-block {
  background: linear-gradient(135deg, #013d7e, #1a5fa8);
  border-radius: 12px; padding: 10px 13px;
  display: none; gap: 8px; align-items: flex-start;
  cursor: pointer;
  transition: box-shadow 0.2s;
  animation: fadeUp 0.35s ease both;
  flex-shrink: 0;
  position: relative; overflow: hidden;
}
.comment-block::before {
  content: ''; position: absolute; top: -20px; right: -20px;
  width: 80px; height: 80px; background: rgba(255,255,255,0.07); border-radius: 50%;
}
.comment-block.visible { display: flex; }
.comment-block:hover { box-shadow: 0 6px 20px rgba(1,61,126,0.25); }
.comment-ico { font-size: 16px; flex-shrink: 0; position: relative; z-index:1; margin-top:1px; }
.comment-inner { flex: 1; position: relative; z-index:1; }
.comment-lbl { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: .14em; color: rgba(255,255,255,0.5); margin-bottom: 3px; }
.comment-txt { font-size: clamp(10px, 1.35vw, 13px); color: #fff; line-height: 1.45; }

/* Metrics */
.metrics { display: flex; flex-direction: column; gap: 7px; flex: 1; }
.metric-row { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; }
.metric-row.single { grid-template-columns: 1fr; }

.metric {
  background: #fff;
  border-radius: 10px; padding: 9px 12px;
  cursor: pointer;
  border: 1.5px solid #edf2f9;
  transition: border-color 0.2s, box-shadow 0.2s;
  animation: fadeUp 0.35s ease both;
  position: relative; overflow: hidden;
}
.metric:hover {
  border-color: #b8d0f0;
  box-shadow: 0 4px 16px rgba(1,61,126,0.10);
}

/* Shimmer */
.metric::before {
  content: ''; position: absolute;
  top: 0; left: -100%; width: 60%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.9), transparent);
  transition: left 0.45s ease;
}
.metric:hover::before { left: 140%; }

.metric-lbl {
  font-size: clamp(8px, 1vw, 10px); font-weight: 800;
  text-transform: uppercase; letter-spacing: .11em;
  color: #8a9ab5; margin-bottom: 4px;
}
.metric-val {
  font-size: clamp(13px, 1.8vw, 18px);
  font-weight: 900; color: #0d1b2e; line-height: 1.1;
}
.metric-val.sal-high { color: #c0392b; }
.metric-val.sal-ok   { color: #1a6b3a; }

.badge {
  display: inline-flex; align-items: center;
  padding: 3px 10px; border-radius: 20px;
  font-size: clamp(11px, 1.5vw, 15px); font-weight: 900;
}
.badge.yes { background: #fde8e6; color: #c0392b; }
.badge.no  { background: #f0f2f5; color: #8a9ab5; }

/* Animations ‚Äî NO scale/translate to avoid blur */
@keyframes fadeUp {
  from { opacity: 0; }
  to   { opacity: 1; }
}

/* Ripple */
.ripple-effect {
  position: absolute; border-radius: 50%;
  background: rgba(1,61,126,0.08);
  transform: scale(0);
  animation: ripple 0.5s linear;
  pointer-events: none;
}
@keyframes ripple { to { transform: scale(5); opacity: 0; } }

.empty { color: #8a9ab5; font-size: 15px; text-align: center; padding: 40px; }
</style>
</head>
<body>
<div id="root" style="display:contents"></div>
<script>
(function(){
  var p       = new URLSearchParams(window.location.search);
  var name    = p.get('name');
  var dataRaw = p.get('data');
  var comment = p.get('comment') || '';
  var sal     = p.get('sal')    || '';
  var avgsal  = p.get('avgsal') || '';
  var salHigh = p.get('salhigh') === '1';
  var start   = p.get('start')  || '\u2014';
  var stop    = p.get('stop')   || '\u2014';
  var review  = p.get('review') || '\u2014';
  var bench   = p.get('bench')  || 'No';
  var iron    = p.get('iron')   || 'No';
  var root    = document.getElementById('root');

  if(!name || !dataRaw){
    document.body.innerHTML = "<p class='empty'>\u2190 \u0412\u044b\u0431\u0435\u0440\u0438 \u0441\u0442\u0440\u043e\u043a\u0443 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 Power BI</p>";
    return;
  }

  var RAW = dataRaw.split('|').map(function(s){
    var lc=s.lastIndexOf(':'), sc=s.lastIndexOf(':',lc-1);
    return { p:s.substring(0,sc), r:parseFloat(s.substring(sc+1,lc))||0, z:parseInt(s.substring(lc+1))||1 };
  }).filter(function(d){ return d.p; });

  if(!RAW.length){ document.body.innerHTML="<p class='empty'>\u041d\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0445</p>"; return; }

  var vals  = RAW.map(function(d){ return d.r; });
  var labs  = RAW.map(function(d){ return d.p; });
  var zones = RAW.map(function(d){ return d.z; });
  var n     = vals.length;

  function fmtPct(v){
    var pct=v*100;
    return (pct<0?'-':'')+Math.abs(pct).toFixed(1).replace('.',',')+'\u0025';
  }
  function fmtMoney(v){
    if(!v||v==='0') return '\u2014';
    return '$\u00a0'+parseInt(v).toLocaleString('ru-RU');
  }
  function isYes(v){ return v&&(v.toLowerCase()==='yes'||v==='1'||v.toLowerCase()==='\u0434\u0430'); }

  var BORDER = {1:'#c0392b', 2:'#9a6e00', 3:'#1a6b3a'};
  var FILL   = {1:'rgba(192,57,43,0.78)', 2:'rgba(154,110,0,0.78)', 3:'rgba(26,107,58,0.78)'};
  var ZCLS   = {1:'z1', 2:'z2', 3:'z3'};
  var benchYes=isYes(bench), ironYes=isYes(iron);

  function ripple(el,e){
    var r=document.createElement('span'); r.className='ripple-effect';
    var rect=el.getBoundingClientRect(), sz=Math.max(rect.width,rect.height);
    r.style.cssText='width:'+sz+'px;height:'+sz+'px;left:'+(e.clientX-rect.left-sz/2)+'px;top:'+(e.clientY-rect.top-sz/2)+'px;';
    el.appendChild(r); setTimeout(function(){ r.remove(); },500);
  }

  var cmntHTML = comment
    ? "<div class='comment-block visible' id='cmnt'><div class='comment-ico'>üí¨</div><div class='comment-inner'><div class='comment-lbl'>\u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439</div><div class='comment-txt'>"+comment+"</div></div></div>"
    : "";

  root.innerHTML =
    "<div class='card-header'>"+
      "<div class='emp-name'>"+name+"</div>"+
      "<div class='emp-sub'>Profitability Dynamics</div>"+
    "</div>"+
    "<div class='card-body'>"+
      "<div class='chart-section'>"+
        "<div class='rent-pills'>"+
          "<div class='pill "+ZCLS[zones[0]]+"' id='p0'><div class='pill-lbl'>\u041f\u0435\u0440\u0432\u044b\u0439 \u043f\u0435\u0440\u0438\u043e\u0434</div><div class='pill-val "+ZCLS[zones[0]]+"'>"+fmtPct(vals[0])+"</div></div>"+
          "<div class='pill "+ZCLS[zones[n-1]]+"' id='p1'><div class='pill-lbl'>\u041f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0439 \u043f\u0435\u0440\u0438\u043e\u0434</div><div class='pill-val "+ZCLS[zones[n-1]]+"'>"+fmtPct(vals[n-1])+"</div></div>"+
        "</div>"+
        "<div class='chart-box'><canvas id='ch'></canvas></div>"+
      "</div>"+
      "<div class='info-section'>"+
        cmntHTML+
        "<div class='metrics'>"+
          "<div class='metric-row'>"+
            "<div class='metric' id='m0'><div class='metric-lbl'>\u0417\u041f</div><div class='metric-val "+(salHigh?'sal-high':'sal-ok')+"'>"+fmtMoney(sal)+"</div></div>"+
            "<div class='metric' id='m1'><div class='metric-lbl'>\u0421\u0440\u0435\u0434\u043d\u044f\u044f \u0417\u041f</div><div class='metric-val'>"+fmtMoney(avgsal)+"</div></div>"+
          "</div>"+
          "<div class='metric-row'>"+
            "<div class='metric' id='m2'><div class='metric-lbl'>\u0421\u0442\u0430\u0440\u0442</div><div class='metric-val'>"+start+"</div></div>"+
            "<div class='metric' id='m3'><div class='metric-lbl'>\u0421\u0442\u043e\u043f</div><div class='metric-val'>"+stop+"</div></div>"+
          "</div>"+
          "<div class='metric-row single'>"+
            "<div class='metric' id='m4'><div class='metric-lbl'>\u0421\u043b\u0435\u0434\u0443\u044e\u0449\u0435\u0435 \u0440\u0435\u0432\u044c\u044e</div><div class='metric-val'>"+review+"</div></div>"+
          "</div>"+
          "<div class='metric-row'>"+
            "<div class='metric' id='m5'><div class='metric-lbl'>2nd Bench</div><span class='badge "+(benchYes?'yes':'no')+"\'>"+( benchYes?'Yes':'No')+"</span></div>"+
            "<div class='metric' id='m6'><div class='metric-lbl'>Iron List</div><span class='badge "+(ironYes?'yes':'no')+"'>"+( ironYes?'Yes':'No')+"</span></div>"+
          "</div>"+
        "</div>"+
      "</div>"+
    "</div>";

  ['p0','p1','m0','m1','m2','m3','m4','m5','m6'].forEach(function(id,i){
    var el=document.getElementById(id);
    if(!el) return;
    el.style.animationDelay=(i*0.04+0.05)+'s';
    el.addEventListener('click',function(e){ ripple(el,e); });
  });
  var cmnt=document.getElementById('cmnt');
  if(cmnt) cmnt.addEventListener('click',function(e){ ripple(cmnt,e); });

  // ‚îÄ‚îÄ CHART ‚îÄ‚îÄ
  var dlPlugin={
    id:'dl',
    afterDatasetsDraw:function(chart){
      var c=chart.ctx, ca=chart.chartArea; if(!ca) return;
      var sz=Math.max(9,Math.min(12,Math.floor((ca.width||300)/(n*4.2))));
      chart.getDatasetMeta(0).data.forEach(function(bar,i){
        c.save();
        c.font='bold '+sz+'px Arial';
        c.fillStyle=BORDER[zones[i]];
        c.textAlign='center';
        var yOff = vals[i]<0 ? 14 : -6;
        c.fillText(fmtPct(vals[i]), bar.x, bar.y+yOff);
        c.restore();
      });
    }
  };

  var zeroPlugin={
    id:'zL',
    afterDraw:function(chart){
      var sc=chart.scales.y; if(!sc) return;
      var y0=sc.getPixelForValue(0), c=chart.ctx;
      c.save();
      c.beginPath();
      c.moveTo(chart.scales.x.left,y0); c.lineTo(chart.scales.x.right,y0);
      c.strokeStyle='rgba(1,61,126,0.2)'; c.lineWidth=1.5; c.setLineDash([4,4]);
      c.stroke(); c.restore();
    }
  };

  new Chart(document.getElementById('ch').getContext('2d'),{
    type:'bar', plugins:[dlPlugin,zeroPlugin],
    data:{
      labels:labs,
      datasets:[{
        data:vals.map(function(v){ return parseFloat((v*100).toFixed(4)); }),
        backgroundColor:zones.map(function(z){ return FILL[z]; }),
        borderColor:zones.map(function(z){ return BORDER[z]; }),
        borderWidth:0, borderRadius:5, borderSkipped:false
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{padding:{top:20,left:2,right:4,bottom:2}},
      animation:{
        duration:700, easing:'easeOutQuart',
        delay:function(ctx){ return (ctx.dataIndex||0)*25; }
      },
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{ label:function(item){ return ' '+fmtPct(vals[item.dataIndex]); } },
          backgroundColor:'#013d7e',
          titleFont:{weight:'bold',size:12,family:'Arial'},
          bodyFont:{size:13,family:'Arial'}, padding:10, cornerRadius:8
        }
      },
      scales:{
        x:{
          grid:{display:false}, border:{display:false},
          ticks:{font:{size:9,family:'Arial',weight:'600'},color:'#8a9ab5',maxRotation:40,autoSkip:true,maxTicksLimit:14}
        },
        y:{ display:false, grace:'20%' }
      }
    }
  });

  window.addEventListener('resize',function(){
    Chart.instances.forEach(function(c){ c.resize(); });
  });
})();
</script>
</body>
</html>