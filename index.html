<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { width: 100%; height: 100%; overflow: hidden; }
  body {
    font-family: Segoe UI, Arial, sans-serif;
    background: #f7f9fc;
    padding: 12px;
    display: flex;
    flex-direction: column;
  }
  .wrap { display: flex; flex-direction: column; gap: 7px; flex: 1; min-height: 0; }

  .hdr h2 {
    color: #013d7e; font-size: clamp(12px, 2vw, 18px);
    font-weight: 800; text-transform: uppercase;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .hdr p { color: #888; font-size: clamp(9px, 1.2vw, 12px); margin-top: 2px; }

  .comment-box {
    background: #fff8e1; border-left: 3px solid #C69200;
    border-radius: 4px; padding: 5px 10px;
    font-size: clamp(9px, 1.2vw, 12px); color: #555; display: none; line-height: 1.4;
  }
  .comment-box.visible { display: block; }
  .comment-box strong {
    color: #C69200; font-size: clamp(8px, 1vw, 10px);
    text-transform: uppercase; letter-spacing: .08em; display: block; margin-bottom: 2px;
  }

  /* Карточки рентабельности */
  .stats { display: grid; grid-template-columns: repeat(3,1fr); gap: 6px; flex-shrink: 0; }
  .sbox { background:#fff; border:1px solid #e4e8f0; border-radius:7px; padding:6px 12px; }
  .slbl { font-size:clamp(8px,1vw,10px); font-weight:700; text-transform:uppercase; color:#aaa; letter-spacing:.06em; white-space:nowrap; }
  .sval { font-size:clamp(14px,2.4vw,22px); font-weight:900; line-height:1.15; }
  .z1 { color:#C00000; } .z2 { color:#C69200; } .z3 { color:#2E7D32; }

  /* Инфо-карточки */
  .info-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 6px;
    flex-shrink: 0;
  }
  .ibox {
    background: #fff; border: 1px solid #e4e8f0;
    border-radius: 7px; padding: 5px 10px;
  }
  .ilbl { font-size: clamp(7px, 0.9vw, 10px); font-weight:700; text-transform:uppercase; color:#aaa; letter-spacing:.05em; white-space:nowrap; }
  .ival { font-size: clamp(11px, 1.6vw, 15px); font-weight:800; color:#222; margin-top:2px; white-space:nowrap; }
  .ival.sal-high { color:#C00000; }
  .ival.sal-ok   { color:#2E7D32; }
  .ival.yes      { color:#C00000; }
  .ival.no       { color:#888; }

  /* График */
  .chart-wrap {
    background: #fff; border: 1px solid #e4e8f0;
    border-radius: 9px; padding: 8px;
    flex: 1; min-height: 0; position: relative;
  }
  .chart-wrap canvas {
    position: absolute; top:8px; left:8px; right:8px; bottom:8px;
    width: calc(100% - 16px) !important;
    height: calc(100% - 16px) !important;
  }
  .empty { color:#bbb; font-size:14px; text-align:center; margin-top:40px; }
</style>
</head>
<body>
<div id="app" style="display:flex;flex-direction:column;flex:1;min-height:0;"></div>
<script>
(function(){
  var p       = new URLSearchParams(window.location.search);
  var name    = p.get('name');
  var dataRaw = p.get('data');
  var comment = p.get('comment') || '';
  var sal     = p.get('sal')     || '';
  var avgsal  = p.get('avgsal')  || '';
  var salHigh = p.get('salhigh') === '1';
  var start   = p.get('start')   || '—';
  var stop    = p.get('stop')    || '—';
  var review  = p.get('review')  || '—';
  var bench   = p.get('bench')   || 'No';
  var iron    = p.get('iron')    || 'No';
  var app     = document.getElementById('app');

  if(!name || !dataRaw){
    app.innerHTML = "<p class='empty'>\u2190 \u0412\u044b\u0431\u0435\u0440\u0438 \u0441\u0442\u0440\u043e\u043a\u0443 \u0432 \u0442\u0430\u0431\u043b\u0438\u0446\u0435 Power BI</p>";
    return;
  }

  var RAW = dataRaw.split('|').map(function(s){
    var lc = s.lastIndexOf(':');
    var sc = s.lastIndexOf(':', lc - 1);
    return { p: s.substring(0, sc), r: parseFloat(s.substring(sc+1, lc))||0, z: parseInt(s.substring(lc+1))||1 };
  }).filter(function(d){ return d.p; });

  if(!RAW.length){ app.innerHTML="<p class='empty'>\u041d\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0445</p>"; return; }

  var vals  = RAW.map(function(d){ return d.r; });
  var labs  = RAW.map(function(d){ return d.p; });
  var zones = RAW.map(function(d){ return d.z; });
  var n     = vals.length;
  var avg   = vals.reduce(function(a,b){ return a+b; },0)/n;

  function fmtPct(v){
    var pct = v*100;
    return (pct<0?'-':'')+Math.abs(pct).toFixed(1).replace('.',',')+'\u0025';
  }
  function fmtMoney(v){
    if(!v) return '\u2014';
    return '$\u00a0'+parseInt(v).toLocaleString('ru-RU');
  }

  var COLORS = {1:'rgba(192,0,0,0.82)',   2:'rgba(198,146,0,0.82)', 3:'rgba(46,125,50,0.82)'};
  var BORDER = {1:'#C00000',              2:'#C69200',              3:'#2E7D32'};
  var ZCLS   = {1:'z1',                   2:'z2',                   3:'z3'};
  function avgZone(v){ return v>=0.10?3:v>0?2:1; }

  var benchYes = bench.toLowerCase()==='yes'||bench==='1'||bench.toLowerCase()==='да';
  var ironYes  = iron.toLowerCase()==='yes' ||iron==='1' ||iron.toLowerCase()==='да';

  var commentHTML = comment
    ? "<div class='comment-box visible'><strong>\u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439</strong>"+comment+"</div>"
    : "";

  app.className = 'wrap';
  app.innerHTML =
    "<div class='hdr'><h2>"+name+"</h2><p>\u0414\u0438\u043d\u0430\u043c\u0438\u043a\u0430 \u0440\u0435\u043d\u0442\u0430\u0431\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u0438 &bull; \u0412\u0441\u0435 \u043f\u0435\u0440\u0438\u043e\u0434\u044b</p></div>"+
    commentHTML+
    // Рентабельность — 3 карточки
    "<div class='stats'>"+
      "<div class='sbox'><div class='slbl'>\u041f\u0435\u0440\u0432\u044b\u0439 \u043f\u0435\u0440\u0438\u043e\u0434</div><div class='sval "+ZCLS[zones[0]]+"'>"+fmtPct(vals[0])+"</div></div>"+
      "<div class='sbox'><div class='slbl'>\u041f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0439 \u043f\u0435\u0440\u0438\u043e\u0434</div><div class='sval "+ZCLS[zones[n-1]]+"'>"+fmtPct(vals[n-1])+"</div></div>"+
      "<div class='sbox'><div class='slbl'>\u0421\u0440\u0435\u0434\u043d\u0435\u0435</div><div class='sval "+ZCLS[avgZone(avg)]+"'>"+fmtPct(avg)+"</div></div>"+
    "</div>"+
    // Инфо-поля — 6 карточек
    "<div class='info-grid'>"+
      "<div class='ibox'><div class='ilbl'>\u0417\u041f</div><div class='ival "+(salHigh?'sal-high':'sal-ok')+"'>"+fmtMoney(sal)+"</div></div>"+
      "<div class='ibox'><div class='ilbl'>\u0421\u0440\u0435\u0434\u043d\u044f\u044f \u0417\u041f</div><div class='ival'>"+fmtMoney(avgsal)+"</div></div>"+
      "<div class='ibox'><div class='ilbl'>\u0421\u0442\u0430\u0440\u0442</div><div class='ival'>"+start+"</div></div>"+
      "<div class='ibox'><div class='ilbl'>\u0421\u0442\u043e\u043f</div><div class='ival'>"+stop+"</div></div>"+
      "<div class='ibox'><div class='ilbl'>\u0420\u0435\u0432\u044c\u044e</div><div class='ival'>"+review+"</div></div>"+
      "<div class='ibox' style='display:grid;grid-template-columns:1fr 1fr;gap:4px;'>"+
        "<div><div class='ilbl'>2nd bench</div><div class='ival "+(benchYes?'yes':'no')+"\'>"+( benchYes?'Yes':'No')+"</div></div>"+
        "<div><div class='ilbl'>Iron list</div><div class='ival "+(ironYes?'yes':'no')+"'>"+( ironYes?'Yes':'No')+"</div></div>"+
      "</div>"+
    "</div>"+
    "<div class='chart-wrap'><canvas id='ch'></canvas></div>";

  function getLabelFont(){
    var w = document.getElementById('ch').offsetWidth||400;
    return 'bold '+Math.max(8,Math.min(12,Math.floor(w/(n*3.2))))+'px Segoe UI';
  }

  var dlPlugin = {
    id:'dl',
    afterDatasetsDraw:function(chart){
      var c2=chart.ctx;
      chart.getDatasetMeta(0).data.forEach(function(bar,i){
        c2.save(); c2.font=getLabelFont(); c2.fillStyle=BORDER[zones[i]];
        c2.textAlign='center'; c2.fillText(fmtPct(vals[i]),bar.x,bar.y-5); c2.restore();
      });
    }
  };

  var avgPlugin = {
    id:'avgL',
    afterDraw:function(chart){
      var y=chart.scales.y.getPixelForValue(avg*100);
      var c2=chart.ctx, xl=chart.scales.x.left, xr=chart.scales.x.right;
      c2.save(); c2.beginPath(); c2.moveTo(xl,y); c2.lineTo(xr,y);
      c2.setLineDash([6,4]); c2.strokeStyle='rgba(1,61,126,0.35)'; c2.lineWidth=1.5; c2.stroke();
      c2.font='bold 10px Segoe UI'; c2.fillStyle='#013d7e'; c2.textAlign='right';
      c2.fillText('avg '+fmtPct(avg),xr,y-4); c2.restore();
    }
  };

  new Chart(document.getElementById('ch').getContext('2d'),{
    type:'bar', plugins:[dlPlugin,avgPlugin],
    data:{
      labels:labs,
      datasets:[{
        data:vals.map(function(v){ return parseFloat((v*100).toFixed(4)); }),
        backgroundColor:zones.map(function(z){ return COLORS[z]; }),
        borderColor:zones.map(function(z){ return BORDER[z]; }),
        borderWidth:1.5, borderRadius:4, borderSkipped:false
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{padding:{top:18,left:2,right:2,bottom:2}},
      animation:{duration:400,easing:'easeOutQuart'},
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{label:function(item){ return ' '+fmtPct(vals[item.dataIndex]); }},
          backgroundColor:'#013d7e', titleFont:{weight:'bold',size:11},
          bodyFont:{size:11}, padding:8, cornerRadius:5
        }
      },
      scales:{
        x:{grid:{display:false}, ticks:{font:{size:9},color:'#999',maxRotation:45,autoSkip:true,maxTicksLimit:20}},
        y:{display:false}
      }
    }
  });

  window.addEventListener('resize',function(){ Chart.instances.forEach(function(c){ c.resize(); }); });
})();
</script>
</body>
</html>